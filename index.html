<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormasChoferes - Iniciar Sesión</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- ... Vistas de Carga, Login, Chofer, Tráfico ... -->
        <div id="loading-view">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">Cargando aplicación...</p>
        </div>

        <div id="login-view" class="hidden w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">FormasChoferes</h1>
                    <p class="text-gray-500 mt-2">Bienvenido. Inicia sesión.</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="email" id="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                        <input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Iniciar Sesión</button>
                </form>
                <div id="login-error" class="mt-4 text-center text-red-500 text-sm"></div>
            </div>
        </div>

        <div id="chofer-view" class="hidden w-full max-w-4xl">
             <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel del Chofer</h2>
                    <button id="logout-button-chofer" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                </div>
                <div id="chofer-content"></div>
            </div>
        </div>

        <div id="trafico-view" class="hidden w-full max-w-6xl">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel de Tráfico</h2>
                    <button id="logout-button-trafico" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                </div>
                <div id="trafico-content" class="mt-6"></div>
            </div>
        </div>

        <!-- VISTA DE ADMINISTRADOR (MODIFICADA) -->
        <div id="administrador-view" class="hidden w-full max-w-7xl">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel de Administración</h2>
                    <button id="logout-button-admin" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                </div>
                 <!-- Pestañas Modificadas -->
                 <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                        <button data-tab="viajes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">Monitor de Viajes</button>
                        <button data-tab="camiones" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Gestión de Camiones</button>
                        <button data-tab="cajas" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Gestión de Cajas</button>
                        <button data-tab="usuarios" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Gestión de Usuarios</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Reportes</button>
                    </nav>
                </div>

                <!-- Contenedores de Pestañas Modificados -->
                <div id="admin-content-viajes" class="admin-tab-content mt-6"></div>
                <div id="admin-content-camiones" class="admin-tab-content hidden mt-6"></div>
                <div id="admin-content-cajas" class="admin-tab-content hidden mt-6"></div>
                <div id="admin-content-usuarios" class="admin-tab-content hidden mt-6"></div>
                <div id="admin-content-reportes" class="admin-tab-content hidden mt-6"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"></div>
    <div id="edit-viaje-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 overflow-y-auto"></div>
    <div id="view-route-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>
    <!-- NUEVO MODAL PARA EDITAR CAJA -->
    <div id="edit-caja-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 overflow-y-auto"></div>

    <script type="module">
        // --- SUPABASE & APP CONFIG ---
        const SUPABASE_URL = 'https://olunfpafoxjsoisqkhri.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sdW5mcGFmb3hqc29pc3FraHJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzQ3MzcsImV4cCI6MjA3NDk1MDczN30.CrqqVhJXSMwqCtNgZDtipcE26OHEgkyfrCNxFEvPp1o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        // --- CORE APP LOGIC ---
        const showAlert = (message, type = 'success') => {
            const el = document.createElement('div');
            el.className = `fixed top-5 right-5 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white py-2 px-4 rounded-lg shadow-lg z-[100] max-w-sm`;
            el.innerHTML = message.replace(/\n/g, '<br>');
            document.body.appendChild(el);
            setTimeout(() => el.remove(), type === 'error' ? 12000 : 4000);
        };
        
        const showView = (viewId) => {
            ['loading-view', 'login-view', 'chofer-view', 'trafico-view', 'administrador-view'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== viewId);
            });
        };
        
        const handleLogin = async (event) => {
            event.preventDefault();
            document.getElementById('login-error').textContent = '';
            const { error } = await supabase.auth.signInWithPassword({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
            });
            if (error) { document.getElementById('login-error').textContent = 'Error: Credenciales inválidas.'; } 
            else { checkSession(); }
        };

        const handleLogout = async () => {
            await supabase.auth.signOut();
            currentUser = null;
            showView('login-view');
        };

        const navigateByUserRole = async (user) => {
            currentUser = user;
            try {
                const { data: profile, error } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                if (error) throw error;

                switch (profile.role) {
                    case 'Chofer': showView('chofer-view'); await loadChoferData(); break;
                    case 'Trafico': showView('trafico-view'); await loadTraficoData(); break;
                    case 'Admin': showView('administrador-view'); await loadAdminData(); break;
                    default: throw new Error(`Rol "${profile.role}" no reconocido.`);
                }
            } catch (err) {
                showAlert(`Error Crítico: ${err.message}.`, 'error');
                console.error("Error de carga de datos:", err);
                handleLogout();
            }
        };
        
        const checkSession = async () => {
             const { data: { session } } = await supabase.auth.getSession();
             if (session) { await navigateByUserRole(session.user); } 
             else { showView('login-view'); }
        };
        
        // --- CHOFER LOGIC ---
        const loadChoferData = async () => {
            const choferContent = document.getElementById('chofer-content');
            choferContent.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: viajes, error } = await supabase.from('viajes').select(`*, camiones(nombre_identificador), cajas(nombre_identificador), coordenadas(*)`).eq('chofer_id', currentUser.id).order('created_at', {ascending: false});
                if (error) throw error;
                
                const viajesAsignados = viajes.filter(v => v.status === 'Asignado');
                choferContent.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Mis Viajes Asignados</h3>
                    <div class="space-y-4">
                    ${viajesAsignados.length === 0 ? '<p>No tienes viajes asignados.</p>' : viajesAsignados.map(v => `
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg">Viaje #${v.id}</h4>
                                    <p class="text-sm text-gray-500">Asignado: ${new Date(v.created_at).toLocaleDateString()}</p>
                                    <p class="text-sm text-gray-600">Vehículo: ${v.camiones?.nombre_identificador || 'N/A'} | Caja: ${v.cajas?.nombre_identificador || 'N/A'}</p>
                                </div>
                                <span class="text-sm font-medium py-1 px-3 rounded-full bg-blue-100 text-blue-800">${v.status}</span>
                            </div>
                            <div class="mt-4">
                                <h5 class="font-semibold">Ruta:</h5>
                                <ol class="list-decimal list-inside mt-2 text-gray-700">${(v.coordenadas && v.coordenadas.length > 0) ? v.coordenadas.sort((a,b)=>a.orden - b.orden).map(c=>`<li>${c.descripcion} - ${c.fecha_entrega}</li>`).join('') : '<li>Sin ruta.</li>'}</ol>
                            </div>
                            <div class="mt-4 text-right"><button data-viaje-id="${v.id}" class="complete-viaje-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Completar Viaje</button></div>
                        </div>`).join('')}
                    </div>`;
            } catch(err) {
                showAlert(`Error al cargar tus viajes: ${err.message}`, 'error');
                choferContent.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };

        const openUploadModal = (viajeId) => {
            const modal = document.getElementById('upload-modal');
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-lg m-auto">
                    <div id="upload-form-container">
                        <h3 class="text-xl font-semibold mb-4">Completar Viaje #${viajeId}</h3>
                        <p class="text-gray-600 mb-6">Sube el comprobante de diésel para marcar este viaje como completado.</p>
                        <form id="complete-trip-form" data-viaje-id="${viajeId}">
                            <div class="mb-4">
                                <label for="pod-file" class="block text-sm font-medium text-gray-700 mb-2">Archivo del Comprobante</label>
                                <input type="file" id="pod-file" name="podFile" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                            <div class="mt-6 flex justify-end gap-4">
                                <button type="button" class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Subir y Completar</button>
                            </div>
                        </form>
                    </div>
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="loader mx-auto"></div>
                        <p class="text-center mt-2">Subiendo archivo, por favor espera...</p>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
        };

        const handleTripCompletion = async (event) => {
            event.preventDefault();
            const form = event.target;
            const viajeId = form.dataset.viajeId;
            const fileInput = document.getElementById('pod-file');
            const file = fileInput.files[0];

            if (!file) { showAlert('Por favor, selecciona un archivo.', 'error'); return; }

            document.getElementById('upload-form-container').classList.add('hidden');
            document.getElementById('upload-progress').classList.remove('hidden');

            try {
                const filePath = `public/${currentUser.id}/${viajeId}-${Date.now()}-${file.name}`;
                const { error: uploadError } = await supabase.storage.from('recibos').upload(filePath, file);
                if (uploadError) throw uploadError;

                const { data: urlData } = supabase.storage.from('recibos').getPublicUrl(filePath);
                const { error: updateError } = await supabase.from('viajes').update({ status: 'Completado', recibo_diesel_url: urlData.publicUrl }).eq('id', viajeId);
                if (updateError) throw updateError;
                
                showAlert('¡Viaje completado con éxito!');
                document.getElementById('upload-modal').classList.add('hidden');
                await loadChoferData();
            } catch (err) {
                showAlert(`Error al completar el viaje: ${err.message}`, 'error');
                document.getElementById('upload-form-container').classList.remove('hidden');
                document.getElementById('upload-progress').classList.add('hidden');
            }
        };
        
        // --- TRAFICO LOGIC ---
        const addCoordenadaInput = (containerId, data = { desc: '', date: '' }) => {
            const container = document.getElementById(containerId);
            if(!container) return;
            const count = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-11 gap-2 items-center';
            div.innerHTML = `
                <div class="col-span-6"><input type="text" name="coordenada_desc" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Descripción ${count + 1}" value="${data.desc}"></div>
                <div class="col-span-4"><input type="date" name="coordenada_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${data.date}"></div>
                <button type="button" class="remove-coordenada-btn text-red-500 hover:text-red-700 font-bold col-span-1 text-lg">X</button>
            `;
            container.appendChild(div);
        };

        const loadTraficoData = async () => {
            const traficoContent = document.getElementById('trafico-content');
            traficoContent.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: choferes } = await supabase.from('profiles').select('id, full_name').eq('role', 'Chofer');
                const { data: camiones } = await supabase.from('camiones').select('id, nombre_identificador');
                const { data: cajas } = await supabase.from('cajas').select('id, nombre_identificador');

                traficoContent.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <h3 class="text-xl font-semibold mb-4">Crear Nuevo Viaje</h3>
                        <form id="create-viaje-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium">Chofer</label><select name="chofer" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${choferes.map(c=>`<option value="${c.id}">${c.full_name}</option>`).join('')}</select></div>
                                <div><label class="block text-sm font-medium">Camión</label><select name="camion" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${camiones.map(c=>`<option value="${c.id}">${c.nombre_identificador}</option>`).join('')}</select></div>
                                <div><label class="block text-sm font-medium">Caja</label><select name="caja" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${cajas.map(c=>`<option value="${c.id}">${c.nombre_identificador}</option>`).join('')}</select></div>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium">Ruta</h4>
                                <div id="coordenadas-container-create" class="mt-2 space-y-3"></div>
                                <button type="button" class="add-coordenada-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 font-semibold py-1 px-3 rounded-lg" data-container="coordenadas-container-create">+ Agregar Parada</button>
                            </div>
                            <div class="pt-4"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700">Asignar Viaje</button></div>
                        </form>
                    </div>
                    <div class="mt-8"><h3 class="text-xl font-semibold mb-4">Viajes Asignados</h3><div id="assigned-viajes-list" class="space-y-4"></div></div>`;
                addCoordenadaInput('coordenadas-container-create');
                await loadAssignedViajes();
            } catch (err) {
                 showAlert(`Error al cargar datos de Tráfico: ${err.message}`, 'error');
                 traficoContent.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };
        const loadAssignedViajes = async () => {
            const listContainer = document.getElementById('assigned-viajes-list');
            listContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            const { data: viajes, error } = await supabase.from('viajes').select(`id, chofer:chofer_id(full_name), camiones(nombre_identificador), cajas(nombre_identificador)`).eq('status', 'Asignado').order('created_at', { ascending: false });
            if(error) { showAlert(`Error: ${error.message}`, 'error'); listContainer.innerHTML = ''; return; }
            if(viajes.length === 0) { listContainer.innerHTML = `<p class="text-gray-500">No hay viajes asignados actualmente.</p>`; return; }
            listContainer.innerHTML = viajes.map(v => `
                <div class="bg-white p-4 rounded-lg border flex justify-between items-center gap-4 flex-wrap">
                    <div>
                        <p class="font-bold">Viaje #${v.id}</p>
                        <p class="text-sm text-gray-600">Chofer: ${v.chofer.full_name}</p>
                        <p class="text-sm text-gray-600">Unidad: ${v.camiones.nombre_identificador} | ${v.cajas.nombre_identificador}</p>
                    </div>
                    <div><button class="edit-viaje-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg" data-viaje-id="${v.id}">Editar</button></div>
                </div>`).join('');
        };
        const openEditViajeModal = async (viajeId) => {
            const modal = document.getElementById('edit-viaje-modal');
            modal.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-md w-full max-w-2xl m-auto"><div class="loader mx-auto"></div></div>`;
            modal.classList.remove('hidden');

            try {
                const { data: viaje, error: viajeError } = await supabase.from('viajes').select('*, coordenadas(*)').eq('id', viajeId).single();
                if (viajeError) throw viajeError;
                
                const { data: choferes } = await supabase.from('profiles').select('id, full_name').eq('role', 'Chofer');
                const { data: camiones } = await supabase.from('camiones').select('id, nombre_identificador');
                const { data: cajas } = await supabase.from('cajas').select('id, nombre_identificador');
                
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-2xl m-auto max-h-[90vh] flex flex-col">
                         <h3 class="text-xl font-semibold mb-6 flex-shrink-0">Editar Viaje #${viajeId}</h3>
                         <form id="edit-viaje-form" data-viaje-id="${viajeId}" class="space-y-4 flex-grow overflow-y-auto pr-2">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium">Chofer</label><select name="chofer" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${choferes.map(c=>`<option value="${c.id}" ${c.id === viaje.chofer_id ? 'selected':''}>${c.full_name}</option>`).join('')}</select></div>
                                <div><label class="block text-sm font-medium">Camión</label><select name="camion" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${camiones.map(c=>`<option value="${c.id}" ${c.id === viaje.camion_id ? 'selected':''}>${c.nombre_identificador}</option>`).join('')}</select></div>
                                <div><label class="block text-sm font-medium">Caja</label><select name="caja" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${cajas.map(c=>`<option value="${c.id}" ${c.id === viaje.caja_id ? 'selected':''}>${c.nombre_identificador}</option>`).join('')}</select></div>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium">Ruta</h4>
                                <div id="coordenadas-container-edit" class="mt-2 space-y-3"></div>
                                <button type="button" class="add-coordenada-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 font-semibold py-1 px-3 rounded-lg" data-container="coordenadas-container-edit">+ Agregar Parada</button>
                            </div>
                         </form>
                         <div class="flex justify-end gap-4 mt-6 pt-4 border-t flex-shrink-0">
                            <button type="button" class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" form="edit-viaje-form" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                         </div>
                    </div>`;

                viaje.coordenadas.sort((a,b)=>a.orden - b.orden).forEach(coord => {
                    addCoordenadaInput('coordenadas-container-edit', { desc: coord.descripcion, date: coord.fecha_entrega });
                });
                if(viaje.coordenadas.length === 0) addCoordenadaInput('coordenadas-container-edit');

            } catch (err) {
                 showAlert(`Error al cargar datos del viaje: ${err.message}`, 'error');
                 modal.classList.add('hidden');
            }
        };
        const handleCreateViaje = async (event) => {
            const form = event.target;
            const formData = new FormData(form);
            const choferId = formData.get('chofer');
            const camionId = formData.get('camion');
            const cajaId = formData.get('caja');

            const { data: viajeData, error: viajeError } = await supabase.from('viajes').insert({
                chofer_id: choferId, camion_id: camionId, caja_id: cajaId, status: 'Asignado'
            }).select().single();
            if (viajeError) throw viajeError;

            const descInputs = Array.from(form.querySelectorAll('input[name="coordenada_desc"]'));
            const dateInputs = Array.from(form.querySelectorAll('input[name="coordenada_date"]'));
            const coordenadas = descInputs.map((descInput, index) => ({
                viaje_id: viajeData.id,
                descripcion: descInput.value,
                fecha_entrega: dateInputs[index].value,
                orden: index + 1
            })).filter(c => c.descripcion && c.fecha_entrega);

            if (coordenadas.length > 0) {
                const { error: coordError } = await supabase.from('coordenadas').insert(coordenadas);
                if (coordError) throw coordError;
            }
            
            showAlert('¡Viaje creado y asignado con éxito!');
            form.reset();
            document.getElementById('coordenadas-container-create').innerHTML = '';
            addCoordenadaInput('coordenadas-container-create');
            await loadAssignedViajes();
        };
        const handleUpdateViaje = async (event) => {
            const form = event.target;
            const viajeId = form.dataset.viajeId;
            const formData = new FormData(form);

            const { error: updateError } = await supabase.from('viajes').update({
                chofer_id: formData.get('chofer'),
                camion_id: formData.get('camion'),
                caja_id: formData.get('caja')
            }).eq('id', viajeId);
            if (updateError) throw updateError;
            
            const { error: deleteError } = await supabase.from('coordenadas').delete().eq('viaje_id', viajeId);
            if(deleteError) throw deleteError;
            
            const descInputs = Array.from(form.querySelectorAll('input[name="coordenada_desc"]'));
            const dateInputs = Array.from(form.querySelectorAll('input[name="coordenada_date"]'));
            const coordenadas = descInputs.map((descInput, index) => ({
                viaje_id: viajeId,
                descripcion: descInput.value,
                fecha_entrega: dateInputs[index].value,
                orden: index + 1
            })).filter(c => c.descripcion && c.fecha_entrega);

            if (coordenadas.length > 0) {
                const { error: coordError } = await supabase.from('coordenadas').insert(coordenadas);
                if (coordError) throw coordError;
            }

            showAlert('¡Viaje actualizado con éxito!');
            document.getElementById('edit-viaje-modal').classList.add('hidden');
            await loadAssignedViajes();
        };

        // --- ADMIN LOGIC ---

        // Reemplazada: Función de filtro para usar dropdowns
        const filterCajas = () => {
            // 1. Obtener valores de los 3 dropdowns.
            const filterTipo = document.getElementById('caja-filter-tipo')?.value || '';
            const filterPropiedad = document.getElementById('caja-filter-propiedad')?.value || '';
            const filterPropietario = document.getElementById('caja-filter-propietario')?.value || '';

            // 2. Obtener el contenedor específico de la lista
            const container = document.getElementById('cajas-list-container');
            if (!container) return;
            
            // 3. Obtener las tarjetas DENTRO de ese contenedor
            const cards = container.getElementsByClassName('caja-card');
            
            // 4. Iterar y verificar
            let visibleCount = 0; // Contador de visibles
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                
                // 5. Leer datos desde data-attributes
                const cardTipo = card.dataset.tipo;
                const cardPropiedad = card.dataset.propiedad;
                const cardPropietario = card.dataset.propietario;

                // 6. Lógica de match (AND)
                // Si el filtro está vacío ("Todos"), es un match.
                // Si no está vacío, compara con el data-attribute.
                const matchTipo = (filterTipo === '') || (cardTipo === filterTipo);
                const matchPropiedad = (filterPropiedad === '') || (cardPropiedad === filterPropiedad);
                const matchPropietario = (filterPropietario === '') || (cardPropietario === filterPropietario);

                if (matchTipo && matchPropiedad && matchPropietario) {
                    card.style.display = 'block';
                    visibleCount++; // Incrementar contador
                } else {
                    card.style.display = 'none';
                }
            }

            // NUEVO: Actualizar leyenda
            const legend = document.getElementById('caja-filter-legend');
            if (legend) {
                const totalCount = legend.dataset.totalCount;
                legend.textContent = `Mostrando ${visibleCount} de ${totalCount} cajas`;
            }
        };

        const openConfirmModal = (message, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm m-auto">
                    <p class="text-center mb-4">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancelar</button>
                        <button id="confirm-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Confirmar</button>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
            document.getElementById('confirm-cancel').onclick = closeConfirmModal;
            document.getElementById('confirm-ok').onclick = onConfirm;
        };
        const closeConfirmModal = () => { document.getElementById('confirm-modal').classList.add('hidden'); };

        const openRouteModal = (coordenadas) => {
             const modal = document.getElementById('view-route-modal');
             modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md m-auto">
                    <h4 class="font-semibold text-lg mb-4">Ruta del Viaje</h4>
                    ${coordenadas && coordenadas.length > 0 ? `
                    <ol class="list-decimal list-inside space-y-2">
                        ${coordenadas.sort((a,b)=>a.orden-b.orden).map(c => `<li><span class="font-medium">${c.descripcion}</span> - ${c.fecha_entrega}</li>`).join('')}
                    </ol>
                    ` : '<p>Este viaje no tiene una ruta definida.</p>'}
                    <div class="text-right mt-6">
                        <button class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
        };

        // Modificado: Carga datos de la pestaña activa
        const loadAdminData = async () => {
            const selectedTab = document.querySelector('.tab-btn.text-blue-600').dataset.tab;
            switch(selectedTab) {
                case 'viajes': await loadAdminViajesData(); break;
                case 'camiones': await loadAdminCamionesData(); break;
                case 'cajas': await loadAdminCajasData(); break;
                case 'usuarios': await loadAdminUsersData(); break;
                case 'reportes': await loadAdminReportsData(); break;
            }
        };
        
        const loadAdminViajesData = async () => {
            const container = document.getElementById('admin-content-viajes');
            container.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: viajes, error } = await supabase.from('viajes').select(`*, chofer:chofer_id(full_name), camiones(nombre_identificador), cajas(nombre_identificador), coordenadas(*)`).order('created_at', { ascending: false });
                if (error) throw error;
                
                const statusColors = {
                    Asignado: 'bg-blue-100 text-blue-800',
                    Completado: 'bg-yellow-100 text-yellow-800',
                    Pagado: 'bg-green-100 text-green-800'
                };

                container.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Monitor de Todos los Viajes</h3>
                    ${viajes.length === 0 ? '<p>No hay viajes registrados.</p>' : `
                        <div class="overflow-x-auto"><table class="min-w-full bg-white text-sm">
                            <thead class="bg-gray-100"><tr>
                                <th class="py-2 px-4 text-left">ID</th>
                                <th class="py-2 px-4 text-left">Fecha</th>
                                <th class="py-2 px-4 text-left">Chofer</th>
                                <th class="py-2 px-4 text-left">Unidad</th>
                                <th class="py-2 px-4 text-center">Estado</th>
                                <th class="py-2 px-4 text-center">Recibo</th>
                                <th class="py-2 px-4 text-center">Ruta</th>
                            </tr></thead>
                            <tbody>${viajes.map(v => `<tr class="border-b">
                                <td class="py-2 px-4 font-mono text-xs">${v.id}</td>
                                <td class="py-2 px-4">${new Date(v.created_at).toLocaleDateString()}</td>
                                <td class="py-2 px-4">${v.chofer?.full_name || 'N/A'}</td>
                                <td class="py-2 px-4">${v.camiones?.nombre_identificador || 'N/A'} / ${v.cajas?.nombre_identificador || 'N/A'}</td>
                                <td class="py-2 px-4 text-center"><span class="py-1 px-3 rounded-full font-medium text-xs ${statusColors[v.status] || ''}">${v.status}</span></td>
                                <td class="py-2 px-4 text-center">${v.recibo_diesel_url ? `<a href="${v.recibo_diesel_url}" target="_blank" class="text-blue-500 hover:underline">Ver</a>` : 'Pendiente'}</td>
                                <td class="py-2 px-4 text-center"><button class="view-route-btn text-blue-500 hover:underline" data-viaje-id="${v.id}">Ver</button></td>
                            </tr>`).join('')}</tbody>
                        </table></div>`}`;
                
                document.querySelectorAll('.view-route-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const viaje = viajes.find(v => v.id == btn.dataset.viajeId);
                        openRouteModal(viaje.coordenadas);
                    });
                });
            } catch (err) {
                showAlert(`Error al cargar los viajes: ${err.message}`, 'error');
                container.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };

        // Modificado: Renombrado y simplificado solo para camiones
        const loadAdminCamionesData = async () => { 
            const camionesContainer = document.getElementById('admin-content-camiones');
            camionesContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: camiones } = await supabase.from('camiones').select('*');
                
                camionesContainer.innerHTML = `
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Camiones</h3>
                        <form id="admin-add-camion-form" class="flex gap-2 mb-4">
                            <input type="text" name="nombre" placeholder="Nuevo Camión (ej. C-01)" required class="flex-grow px-3 py-2 border rounded-lg">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">+</button>
                        </form>
                        <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">${camiones.map(c => `
                            <div class="bg-gray-50 p-2 rounded-lg flex justify-between items-center">
                                <span>${c.nombre_identificador}</span>
                                <button class="delete-fleet-btn text-red-500 hover:text-red-700" data-id="${c.id}" data-type="camiones">Eliminar</button>
                            </div>`).join('')}
                        </div>
                    </div>`;
            } catch(err) {
                showAlert(`Error al cargar camiones: ${err.message}`, 'error');
                camionesContainer.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };

        // Nuevo: Carga los datos y el formulario para Cajas
        const loadAdminCajasData = async () => {
            const cajasContainer = document.getElementById('admin-content-cajas');
            cajasContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                // MODIFICADO: Bucle para obtener todos los registros (paginación)
                let allCajas = [];
                let rangeStart = 0;
                const rangeSize = 1000; // Tamaño del lote
                let hasMore = true;

                while(hasMore) {
                    const { data: cajasLote, error } = await supabase
                        .from('cajas')
                        .select('*')
                        .order('nombre_identificador', { ascending: true })
                        .range(rangeStart, rangeStart + rangeSize - 1);

                    if (error) throw error;
                    
                    allCajas = allCajas.concat(cajasLote);
                    
                    if (cajasLote.length < rangeSize) {
                        hasMore = false;
                    } else {
                        rangeStart += rangeSize;
                    }
                }
                // FIN del bucle. 'allCajas' tiene todo.
                
                // NUEVO: Extraer valores únicos para filtros (usando 'allCajas')
                const tipos = [...new Set(allCajas.map(c => c.tipo).filter(Boolean))].sort();
                const propiedades = [...new Set(allCajas.map(c => c.propiedad).filter(Boolean))].sort();
                const propietarios = [...new Set(allCajas.map(c => c.propietario).filter(Boolean))].sort();

                cajasContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Agregar Nueva Caja</h3>
                            <form id="admin-add-caja-form" class="bg-gray-50 p-4 rounded-lg space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                                <div><label class="block text-sm">Nombre Identificador</label><input type="text" name="nombre_identificador" required class="w-full mt-1 p-2 border rounded-md"></div>
                                <div><label class="block text-sm">Placa</label><input type="text" name="placa" required class="w-full mt-1 p-2 border rounded-md"></div>
                                <div><label class="block text-sm">Tipo</label><input type="text" name="tipo" required class="w-full mt-1 p-2 border rounded-md"></div>
                                <div><label class="block text-sm">Medida</label><input type="text" name="medida" required class="w-full mt-1 p-2 border rounded-md"></div>
                                <div><label class="block text-sm">Núm. Llantas</label><input type="text" name="num_llantas" required class="w-full mt-1 p-2 border rounded-md"></div>
                                <div><label class="block text-sm">Propietario</label><input type="text" name="propietario" required class="w-full mt-1 p-2 border rounded-md"></div>
                                
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm">Origen</label>
                                        <select name="origen" required class="w-full mt-1 p-2 border rounded-md">
                                            <option value="Nacional">Nacional</option>
                                            <option value="Extranjero">Extranjero</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm">Propiedad</label>
                                        <select name="propiedad" required class="w-full mt-1 p-2 border rounded-md">
                                            <option value="Propio">Propio</option>
                                            <option value="Ajeno">Ajeno</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm">Estatus</label>
                                        <select name="estatus" required class="w-full mt-1 p-2 border rounded-md">
                                            <option value="Activo">Activo</option>
                                            <option value="Inactivo">Inactivo</option>
                                            <option value="Mantenimiento">Mantenimiento</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Agregar Caja</button>
                            </form>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Cajas (Remolques) Existentes</h3>
                            
                            <!-- Filtros Reemplazados -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                                <div>
                                    <label for="caja-filter-tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                                    <select id="caja-filter-tipo" class="caja-filter-select mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="">Todos</option>
                                        ${tipos.map(t => `<option value="${t}">${t}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="caja-filter-propiedad" class="block text-sm font-medium text-gray-700">Propiedad</label>
                                    <select id="caja-filter-propiedad" class="caja-filter-select mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="">Todas</option>
                                        <!-- MODIFICADO: Añadir 'selected' si el valor es 'Propio' -->
                                        ${propiedades.map(p => `<option value="${p}" ${p === 'Propio' ? 'selected' : ''}>${p}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="caja-filter-propietario" class="block text-sm font-medium text-gray-700">Propietario</label>
                                    <select id="caja-filter-propietario" class="caja-filter-select mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="">Todos</option>
                                        ${propietarios.map(p => `<option value="${p}">${p}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- NUEVA LEYENDA (usa allCajas.length) -->
                            <div id="caja-filter-legend" class="text-sm text-gray-600 mb-4" data-total-count="${allCajas.length}">
                                Mostrando ${allCajas.length} de ${allCajas.length} cajas
                            </div>

                            <!-- Contenedor de la lista modificado (altura ajustada) -->
                            <div id="cajas-list-container" class="space-y-3 max-h-[55vh] overflow-y-auto pr-2">
                            ${allCajas.length === 0 ? '<p>No hay cajas registradas.</p>' :
                            allCajas.map(c => `
                                <!-- Se agregaron data-attributes -->
                                <div class="caja-card bg-gray-50 p-3 rounded-lg border" 
                                     data-tipo="${c.tipo || ''}" 
                                     data-propiedad="${c.propiedad || ''}" 
                                     data-propietario="${c.propietario || ''}">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-base">${c.nombre_identificador}</span>
                                        <!-- MODIFICADO: Contenedor para botones -->
                                        <div class="flex-shrink-0 flex gap-3">
                                            <!-- NUEVO BOTÓN -->
                                            <button class="edit-caja-btn text-blue-500 hover:text-blue-700 text-sm" data-caja-id="${c.id}">Editar</button>
                                            <button class="delete-fleet-btn text-red-500 hover:text-red-700 text-sm" data-id="${c.id}" data-type="cajas">Eliminar</button>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-sm text-gray-700 grid grid-cols-2 gap-x-4 gap-y-1">
                                        <p><strong>Placa:</strong> ${c.placa || 'N/A'}</p>
                                        <p><strong>Tipo:</strong> ${c.tipo || 'N/A'}</p>
                                        <p><strong>Medida:</strong> ${c.medida || 'N/A'}</p>
                                        <p><strong>Estatus:</strong> <span class="font-medium ${c.estatus === 'Activo' ? 'text-green-600' : 'text-gray-500'}">${c.estatus || 'N/A'}</span></p>
                                        <p><strong>Propiedad:</strong> ${c.propiedad || 'N/A'}</p>
                                        <p><strong>Propietario:</strong> ${c.propietario || 'N/A'}</p>
                                    </div>
                                </div>
                                `).join('')
                            }
                            </div>
                        </div>
                    </div>`;
                
                // Reemplazado: Agregar event listener para los dropdowns
                const filterSelects = cajasContainer.querySelectorAll('.caja-filter-select');
                filterSelects.forEach(select => {
                    select.addEventListener('change', filterCajas);
                });

                // NUEVO: Llamar a filterCajas() una vez al cargar para aplicar el filtro por default
                filterCajas();

            } catch(err) {
                showAlert(`Error al cargar las cajas: ${err.message}`, 'error');
                cajasContainer.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };

        // NUEVO: Abre el modal para editar una caja
        const openEditCajaModal = async (cajaId) => {
            const modal = document.getElementById('edit-caja-modal');
            modal.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-md w-full max-w-lg m-auto"><div class="loader mx-auto"></div><p class="text-center mt-2">Cargando datos...</p></div>`;
            modal.classList.remove('hidden');

            try {
                const { data: caja, error } = await supabase.from('cajas').select('*').eq('id', cajaId).single();
                if (error) throw error;
                if (!caja) throw new Error('Caja no encontrada.');

                // HTML del formulario (copiado y adaptado de loadAdminCajasData)
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-lg m-auto max-h-[90vh] flex flex-col">
                        <h3 class="text-xl font-semibold mb-6 flex-shrink-0">Editar Caja: ${caja.nombre_identificador}</h3>
                        <form id="edit-caja-form" data-caja-id="${caja.id}" class="space-y-4 flex-grow overflow-y-auto pr-2">
                            <div><label class="block text-sm">Nombre Identificador</label><input type="text" name="nombre_identificador" required class="w-full mt-1 p-2 border rounded-md" value="${caja.nombre_identificador || ''}"></div>
                            <div><label class="block text-sm">Placa</label><input type="text" name="placa" required class="w-full mt-1 p-2 border rounded-md" value="${caja.placa || ''}"></div>
                            <div><label class="block text-sm">Tipo</label><input type="text" name="tipo" required class="w-full mt-1 p-2 border rounded-md" value="${caja.tipo || ''}"></div>
                            <div><label class="block text-sm">Medida</label><input type="text" name="medida" required class="w-full mt-1 p-2 border rounded-md" value="${caja.medida || ''}"></div>
                            <div><label class="block text-sm">Núm. Llantas</label><input type="text" name="num_llantas" required class="w-full mt-1 p-2 border rounded-md" value="${caja.num_llantas || ''}"></div>
                            <div><label class="block text-sm">Propietario</label><input type="text" name="propietario" required class="w-full mt-1 p-2 border rounded-md" value="${caja.propietario || ''}"></div>
                            
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm">Origen</label>
                                    <select name="origen" required class="w-full mt-1 p-2 border rounded-md">
                                        <option value="Nacional" ${caja.origen === 'Nacional' ? 'selected' : ''}>Nacional</option>
                                        <option value="Extranjero" ${caja.origen === 'Extranjero' ? 'selected' : ''}>Extranjero</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm">Propiedad</label>
                                    <select name="propiedad" required class="w-full mt-1 p-2 border rounded-md">
                                        <option value="Propio" ${caja.propiedad === 'Propio' ? 'selected' : ''}>Propio</option>
                                        <option value="Ajeno" ${caja.propiedad === 'Ajeno' ? 'selected' : ''}>Ajeno</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm">Estatus</label>
                                    <select name="estatus" required class="w-full mt-1 p-2 border rounded-md">
                                        <option value="Activo" ${caja.estatus === 'Activo' ? 'selected' : ''}>Activo</option>
                                        <option value="Inactivo" ${caja.estatus === 'Inactivo' ? 'selected' : ''}>Inactivo</option>
                                        <option value="Mantenimiento" ${caja.estatus === 'Mantenimiento' ? 'selected' : ''}>Mantenimiento</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                        <div class="flex justify-end gap-4 mt-6 pt-4 border-t flex-shrink-0">
                            <button type="button" class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" form="edit-caja-form" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                        </div>
                    </div>`;

            } catch (err) {
                showAlert(`Error al cargar la caja: ${err.message}`, 'error');
                modal.classList.add('hidden');
            }
        };

        const loadAdminUsersData = async () => { 
             const usersContainer = document.getElementById('admin-content-usuarios');
            usersContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: profiles } = await supabase.from('profiles').select('*');
                usersContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Usuarios Activos</h3>
                        <div class="space-y-2">${profiles.map(u => `
                            <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-semibold">${u.full_name || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">${u.role || 'N/A'} ${u.role === 'Chofer' ? `| ${u.tipo_operador || 'N/A'}`: ''}</p>
                                </div>
                                <button class="delete-user-btn text-red-500 hover:text-red-700" data-user-id="${u.id}">Eliminar</button>
                            </div>`).join('')}
                        </div>
                    </div>
                    <div>
                         <h3 class="text-xl font-semibold mb-4">Crear Nuevo Usuario</h3>
                         <form id="create-user-form" class="bg-gray-50 p-4 rounded-lg space-y-4">
                            <div><label class="block text-sm">Nombre Completo</label><input type="text" name="fullname" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="block text-sm">Correo Electrónico</label><input type="email" name="email" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="block text-sm">Contraseña</label><input type="password" name="password" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div>
                                <label class="block text-sm">Rol</label>
                                <select name="role" required class="w-full mt-1 p-2 border rounded-md">
                                    <option value="Chofer">Chofer</option><option value="Trafico">Tráfico</option><option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div id="tipo-operador-container">
                                <label class="block text-sm">Tipo de Operador (Si es Chofer)</label>
                                <select name="tipo_operador" class="w-full mt-1 p-2 border rounded-md">
                                    <option value="Local">Local</option><option value="Cruce">Cruce</option><option value="Foráneo Chihuahua">Foráneo Chihuahua</option><option value="Foráneo Pacífico">Foráneo Pacífico</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Crear Usuario</button>
                         </form>
                    </div>
                </div>`;

                const roleSelect = usersContainer.querySelector('select[name="role"]');
                const tipoOperadorContainer = usersContainer.querySelector('#tipo-operador-container');
                roleSelect.addEventListener('change', () => {
                    tipoOperadorContainer.style.display = roleSelect.value === 'Chofer' ? 'block' : 'none';
                });
                tipoOperadorContainer.style.display = roleSelect.value === 'Chofer' ? 'block' : 'none';

            } catch (err) {
                 showAlert(`Error al cargar usuarios: ${err.message}`, 'error');
                 usersContainer.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };
        const loadAdminReportsData = async () => {
            const container = document.getElementById('admin-content-reportes');
            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Generar Reportes en Excel</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-semibold text-lg mb-2">Reporte de Viajes Asignados</h4>
                        <p class="text-gray-600 mb-4 text-sm">Descarga una lista de todos los viajes que están actualmente en curso y pendientes de completar por los choferes.</p>
                        <button data-status="Asignado" class="download-report-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Descargar Asignados</button>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-semibold text-lg mb-2">Reporte de Viajes Completados</h4>
                        <p class="text-gray-600 mb-4 text-sm">Descarga un historial de todos los viajes que han sido completados, incluyendo los que ya han sido pagados.</p>
                        <button data-status="Completado" class="download-report-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Descargar Completados y Pagados</button>
                    </div>
                    <!-- NUEVO REPORTE DE CAJAS -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-semibold text-lg mb-2">Reporte General de Cajas</h4>
                        <p class="text-gray-600 mb-4 text-sm">Descarga una lista completa de todas las cajas (remolques) registradas en el sistema.</p>
                        <button id="download-cajas-report-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">Descargar Reporte de Cajas</button>
                    </div>
                </div>
            `;
        };
        const handleDownloadReport = async (statuses) => {
            showAlert('Generando reporte, por favor espera...');
            try {
                const { data: viajes, error } = await supabase.from('viajes').select(`*, chofer:chofer_id(full_name), camiones(nombre_identificador), cajas(nombre_identificador), coordenadas(*)`).in('status', statuses).order('created_at', { ascending: false });
                if (error) throw error;
                if (viajes.length === 0) { showAlert('No hay datos para generar este reporte.', 'error'); return; }

                const reportData = viajes.map(v => {
                    const baseData = {
                        'ID Viaje': v.id,
                        'Fecha': new Date(v.created_at).toLocaleDateString(),
                        'Chofer': v.chofer?.full_name,
                        'Camion': v.camiones?.nombre_identificador,
                        'Caja': v.cajas?.nombre_identificador,
                        'Estado': v.status,
                        'URL Recibo': v.recibo_diesel_url,
                        'Pago Total': v.pago_total,
                        'Desglose Pago': v.pago_desglose ? JSON.stringify(v.pago_desglose) : ''
                    };

                    if (v.coordenadas) {
                        v.coordenadas.sort((a, b) => a.orden - b.orden);
                        v.coordenadas.forEach((coord, index) => {
                            baseData[`Coordenada ${index + 1}`] = `${coord.descripcion} (${coord.fecha_entrega})`;
                        });
                    }
                    
                    return baseData;
                });
                
                const worksheet = XLSX.utils.json_to_sheet(reportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Viajes");
                const fileName = `Reporte_Viajes_${statuses.join('_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);

            } catch (err) { showAlert(`Error al generar el reporte: ${err.message}`, 'error'); }
        };

        // NUEVO: Maneja la descarga del reporte de cajas
        const handleDownloadCajasReport = async () => {
            showAlert('Generando reporte de cajas, esto puede tardar un momento...');
            try {
                // Reutilizar la lógica de paginación para obtener TODAS las cajas
                let allCajas = [];
                let rangeStart = 0;
                const rangeSize = 1000;
                let hasMore = true;

                while(hasMore) {
                    const { data: cajasLote, error } = await supabase
                        .from('cajas')
                        .select('*')
                        .order('nombre_identificador', { ascending: true })
                        .range(rangeStart, rangeStart + rangeSize - 1);

                    if (error) throw error;
                    
                    allCajas = allCajas.concat(cajasLote);
                    
                    if (cajasLote.length < rangeSize) {
                        hasMore = false;
                    } else {
                        rangeStart += rangeSize;
                    }
                }
                // Fin del bucle, 'allCajas' tiene todo.

                if (allCajas.length === 0) {
                    showAlert('No hay cajas para generar este reporte.', 'error');
                    return;
                }

                // Definir el orden y nombre de las columnas
                const reportData = allCajas.map(c => ({
                    'Nombre Identificador': c.nombre_identificador,
                    'Placa': c.placa,
                    'Tipo': c.tipo,
                    'Medida': c.medida,
                    'Num. Llantas': c.num_llantas,
                    'Propietario': c.propietario,
                    'Origen': c.origen,
                    'Propiedad': c.propiedad,
                    'Estatus': c.estatus,
                    'ID (Sistema)': c.id,
                    'Fecha Creación': new Date(c.created_at).toLocaleString()
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(reportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cajas");
                
                // Ajustar anchos de columna (opcional pero útil)
                const wscols = [
                    { wch: 25 }, // Nombre
                    { wch: 15 }, // Placa
                    { wch: 15 }, // Tipo
                    { wch: 10 }, // Medida
                    { wch: 15 }, // Num. Llantas
                    { wch: 20 }, // Propietario
                    { wch: 15 }, // Origen
                    { wch: 15 }, // Propiedad
                    { wch: 15 }, // Estatus
                    { wch: 30 }, // ID
                    { wch: 20 }  // Fecha
                ];
                worksheet['!cols'] = wscols;

                const fileName = `Reporte_General_Cajas_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);

            } catch (err) { 
                showAlert(`Error al generar el reporte de cajas: ${err.message}`, 'error'); 
            }
        };

        // Modificado: Renombrado
        const handleCamionAdd = async (event) => {
             const form = event.target;
             const nombre = form.nombre.value;
             const { error } = await supabase.from('camiones').insert({ nombre_identificador: nombre });
             if (error) { showAlert(`Error: ${error.message}`, 'error'); }
             else { showAlert('¡Camión agregado con éxito!'); form.reset(); await loadAdminCamionesData(); }
        };

        // Nuevo: Maneja el formulario de agregar caja
        const handleCajaAdd = async (event) => {
            const form = event.target;
            try {
                const formData = new FormData(form);
                const newCaja = {
                    nombre_identificador: formData.get('nombre_identificador'),
                    placa: formData.get('placa'),
                    tipo: formData.get('tipo'),
                    medida: formData.get('medida'),
                    num_llantas: formData.get('num_llantas'),
                    propietario: formData.get('propietario'),
                    origen: formData.get('origen'),
                    propiedad: formData.get('propiedad'),
                    estatus: formData.get('estatus'),
                };
                
                // Verificación manual (aunque 'required' ayuda)
                for (const key in newCaja) {
                    if (!newCaja[key]) {
                        throw new Error(`El campo '${key.replace('_', ' ')}' es obligatorio.`);
                    }
                }
                
                const { error } = await supabase.from('cajas').insert(newCaja);
                if (error) throw error;
                
                showAlert('¡Caja agregada con éxito!');
                form.reset();
                await loadAdminCajasData();

            } catch (err) {
                showAlert(`Error al agregar la caja: ${err.message}`, 'error');
            }
        };

        // NUEVO: Maneja el formulario de editar caja
        const handleUpdateCaja = async (event) => {
            const form = event.target;
            const cajaId = form.dataset.cajaId;
            try {
                const formData = new FormData(form);
                const updatedCaja = {
                    nombre_identificador: formData.get('nombre_identificador'),
                    placa: formData.get('placa'),
                    tipo: formData.get('tipo'),
                    medida: formData.get('medida'),
                    num_llantas: formData.get('num_llantas'),
                    propietario: formData.get('propietario'),
                    origen: formData.get('origen'),
                    propiedad: formData.get('propiedad'),
                    estatus: formData.get('estatus'),
                };

                // Verificación
                for (const key in updatedCaja) {
                    if (!updatedCaja[key]) {
                        throw new Error(`El campo '${key.replace('_', ' ')}' es obligatorio.`);
                    }
                }
                
                const { error } = await supabase.from('cajas').update(updatedCaja).eq('id', cajaId);
                if (error) throw error;
                
                showAlert('¡Caja actualizada con éxito!');
                document.getElementById('edit-caja-modal').classList.add('hidden');
                await loadAdminCajasData(); // Recargar la lista

            } catch (err) {
                showAlert(`Error al actualizar la caja: ${err.message}`, 'error');
            }
        };

        // Modificado: Recarga los datos de la pestaña correcta
        const handleFleetDelete = async (id, type) => {
            // VALIDACIÓN MEJORADA
            if (type === 'cajas') {
                try {
                    // 1. Validar si la caja está en un viaje 'Asignado'
                    const { data: viajes, error: checkError } = await supabase
                        .from('viajes')
                        .select('id')
                        .eq('caja_id', id)
                        .eq('status', 'Asignado')
                        .limit(1);
    
                    if (checkError) throw checkError;
    
                    // 2. Si se encuentra un viaje, mostrar error y detener
                    if (viajes && viajes.length > 0) {
                        showAlert('No se puede eliminar: La caja está asignada a un viaje activo (Asignado).', 'error');
                        return;
                    }
    
                    // 3. Si no hay viajes, mostrar la confirmación
                    openConfirmModal(`¿Seguro que quieres eliminar esta caja?`, async () => {
                        const { error } = await supabase.from('cajas').delete().eq('id', id);
                        if (error) { showAlert(`Error: ${error.message}`, 'error'); } 
                        else { 
                            showAlert('Caja eliminada.'); 
                            await loadAdminCajasData();
                        }
                        closeConfirmModal();
                    });
    
                } catch (err) {
                    showAlert(`Error de validación: ${err.message}`, 'error');
                }
            } 
            // Lógica original para 'camiones' (o cualquier otro tipo)
            else {
                openConfirmModal(`¿Seguro que quieres eliminar este elemento?`, async () => {
                    const { error } = await supabase.from(type).delete().eq('id', id);
                    if (error) { showAlert(`Error: ${error.message}`, 'error'); } 
                    else { 
                        showAlert('Elemento eliminado.'); 
                        if (type === 'camiones') {
                            await loadAdminCamionesData();
                        }
                    }
                    closeConfirmModal();
                });
            }
        };

        const handleCreateUser = async (event) => {
            const { data: { session: adminSession } } = await supabase.auth.getSession();
            if (!adminSession) { showAlert('Error de autenticación.', 'error'); return; }
            try {
                const formData = new FormData(event.target);
                const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email: formData.get('email'), password: formData.get('password') });
                if (signUpError) throw signUpError;
                const { error: profileError } = await supabase.from('profiles').insert({
                    id: signUpData.user.id, full_name: formData.get('fullname'), role: formData.get('role'),
                    tipo_operador: formData.get('role') === 'Chofer' ? formData.get('tipo_operador') : null
                });
                if (profileError) throw profileError;
                showAlert('¡Usuario creado con éxito!');
                event.target.reset();
                await loadAdminUsersData();
            } catch (err) {
                if (err.message && err.message.includes('User already registered')) {
                     showAlert('Este correo ya está registrado en el sistema. Si el usuario fue eliminado previamente, su registro de autenticación aún existe. Por favor, usa un correo diferente o contacta al administrador de la base de datos.', 'error');
                } else {
                    showAlert(`Error: ${err.message}`, 'error');
                }
            } finally {
                await supabase.auth.setSession({ access_token: adminSession.access_token, refresh_token: adminSession.refresh_token, });
            }
        };
        const handleDeleteUser = async (userId) => {
            if (userId === currentUser.id) { showAlert('No puedes eliminar tu propia cuenta.', 'error'); return; }
            openConfirmModal(`¿Seguro que quieres eliminar este perfil de usuario? La cuenta de autenticación no se eliminará.`, async () => {
                const { error } = await supabase.from('profiles').delete().eq('id', userId);
                if (error) { showAlert(`Error: ${error.message}`, 'error'); }
                else { showAlert('Perfil de usuario eliminado.'); await loadAdminUsersData(); }
                closeConfirmModal();
            });
        };
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if(!button) return;

            if(button.id.startsWith('logout-button')) handleLogout();
            if(button.classList.contains('tab-btn')) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                });
                button.classList.add('text-blue-600', 'border-blue-600');
                document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`admin-content-${button.dataset.tab}`).classList.remove('hidden');
                loadAdminData();
            }
            if(button.classList.contains('add-coordenada-btn')) addCoordenadaInput(button.dataset.container);
            if(button.classList.contains('remove-coordenada-btn')) button.parentElement.remove();
            if(button.classList.contains('edit-viaje-btn')) openEditViajeModal(button.dataset.viajeId);
            // NUEVO
            if(button.classList.contains('edit-caja-btn')) openEditCajaModal(button.dataset.cajaId);
            if(button.classList.contains('close-modal-btn')) button.closest('.fixed').classList.add('hidden');
            if(button.classList.contains('delete-fleet-btn')) handleFleetDelete(button.dataset.id, button.dataset.type);
            if(button.classList.contains('delete-user-btn')) handleDeleteUser(button.dataset.userId);
            if(button.classList.contains('complete-viaje-btn')) openUploadModal(button.dataset.viajeId);
            if(button.classList.contains('download-report-btn')) {
                const status = button.dataset.status;
                const statuses = status === 'Completado' ? ['Completado', 'Pagado'] : [status];
                handleDownloadReport(statuses);
            }
            // NUEVO
            if(button.id === 'download-cajas-report-btn') handleDownloadCajasReport();
        });

        // Modificado: Llama a las nuevas funciones de submit
        document.addEventListener('submit', async (event) => {
            try {
                event.preventDefault();
                const form = event.target;
                if (form.id === 'create-viaje-form') await handleCreateViaje(event);
                if (form.id === 'edit-viaje-form') await handleUpdateViaje(event);
                if (form.id === 'complete-trip-form') await handleTripCompletion(event);
                if (form.id === 'admin-add-camion-form') await handleCamionAdd(event);
                if (form.id === 'admin-add-caja-form') await handleCajaAdd(event);
                // NUEVO
                if (form.id === 'edit-caja-form') await handleUpdateCaja(event);
                if (form.id === 'create-user-form') await handleCreateUser(event);
            } catch (err) {
                showAlert(`Error: ${err.message}`, 'error');
                console.error("Submit error:", err);
            }
        });

        checkSession();
    </script>
</body>
</html>










