<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormasChoferes - Iniciar Sesión</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS (for Excel export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div id="loading-view">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">Cargando aplicación...</p>
        </div>

        <div id="login-view" class="hidden w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">FormasChoferes</h1>
                    <p class="text-gray-500 mt-2">Bienvenido. Inicia sesión.</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="email" id="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                        <input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Iniciar Sesión</button>
                </form>
                <div id="login-error" class="mt-4 text-center text-red-500 text-sm"></div>
            </div>
        </div>

        <div id="chofer-view" class="hidden w-full max-w-4xl">
             <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel del Chofer</h2>
                    <button id="logout-button-chofer" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                </div>
                <div id="chofer-content"></div>
            </div>
        </div>

        <div id="trafico-view" class="hidden w-full max-w-6xl">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel de Tráfico</h2>
                    <button id="logout-button-trafico" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                </div>
                <div id="trafico-content" class="mt-6"></div>
            </div>
        </div>

        <div id="administrador-view" class="hidden w-full max-w-7xl">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel de Administración</h2>
                    <button id="logout-button-admin" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                </div>
                 <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                        <button data-tab="viajes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">Monitor de Viajes</button>
                        <!-- Pestaña renombrada -->
                        <button data-tab="camiones" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Gestión de Camiones</button>
                        <!-- Nueva pestaña -->
                        <button data-tab="cajas" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Gestión de Cajas</button>
                        <button data-tab="usuarios" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Gestión de Usuarios</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent">Reportes</button>
                    </nav>
                </div>

                <div id="admin-content-viajes" class="admin-tab-content mt-6"></div>
                <!-- Contenedor renombrado -->
                <div id="admin-content-camiones" class="admin-tab-content hidden mt-6"></div>
                <!-- Nuevo contenedor -->
                <div id="admin-content-cajas" class="admin-tab-content hidden mt-6"></div>
                <div id="admin-content-usuarios" class="admin-tab-content hidden mt-6"></div>
                <div id="admin-content-reportes" class="admin-tab-content hidden mt-6"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"></div>
    <div id="edit-viaje-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 overflow-y-auto"></div>
    <!-- Nuevo modal para editar caja -->
    <div id="edit-caja-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 overflow-y-auto"></div>
    <div id="view-route-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"></div>

    <script type="module">
        // --- SUPABASE & APP CONFIG ---
        const SUPABASE_URL = 'https://olunfpafoxjsoisqkhri.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9sdW5mcGFmb3hqc29pc3FraHJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzQ3MzcsImV4cCI6MjA3NDk1MDczN30.CrqqVhJXSMwqCtNgZDtipcE26OHEgkyfrCNxFEvPp1o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let adminDropdownCache = {}; // Cache para los dropdowns de admin (camiones, cajas)

        // --- CORE APP LOGIC ---
        const showAlert = (message, type = 'success') => {
            const el = document.createElement('div');
            el.className = `fixed top-5 right-5 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white py-2 px-4 rounded-lg shadow-lg z-[100] max-w-sm`;
            el.innerHTML = message.replace(/\n/g, '<br>');
            document.body.appendChild(el);
            setTimeout(() => el.remove(), type === 'error' ? 12000 : 4000);
        };
        
        const showView = (viewId) => {
            ['loading-view', 'login-view', 'chofer-view', 'trafico-view', 'administrador-view'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== viewId);
            });
        };
        
        const handleLogin = async (event) => {
            event.preventDefault();
            document.getElementById('login-error').textContent = '';
            const { error } = await supabase.auth.signInWithPassword({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
            });
            if (error) { document.getElementById('login-error').textContent = 'Error: Credenciales inválidas.'; } 
            else { checkSession(); }
        };

        const handleLogout = async () => {
            await supabase.auth.signOut();
            currentUser = null;
            showView('login-view');
        };

        const navigateByUserRole = async (user) => {
            currentUser = user;
            try {
                const { data: profile, error } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                if (error) throw error;

                switch (profile.role) {
                    case 'Chofer': showView('chofer-view'); await loadChoferData(); break;
                    case 'Trafico': showView('trafico-view'); await loadTraficoData(); break;
                    case 'Admin': showView('administrador-view'); await loadAdminData(); break;
                    default: throw new Error(`Rol "${profile.role}" no reconocido.`);
                }
            } catch (err) {
                showAlert(`Error Crítico: ${err.message}.`, 'error');
                console.error("Error de carga de datos:", err);
                handleLogout();
            }
        };
        
        const checkSession = async () => {
             const { data: { session } } = await supabase.auth.getSession();
             if (session) { await navigateByUserRole(session.user); } 
             else { showView('login-view'); }
        };
        
        // --- Lógica de carga de datos comunes (para Tráfico) ---
        const loadAdminDropdowns = async (force = false) => {
            if (force || !adminDropdownCache.camiones) {
                const { data } = await supabase.from('camiones').select('id, nombre_identificador');
                adminDropdownCache.camiones = data || [];
            }
            if (force || !adminDropdownCache.cajas) {
                // Optimizado: Solo trae id y nombre
                const { data } = await supabase.from('cajas').select('id, nombre_identificador');
                adminDropdownCache.cajas = data || [];
            }
        };
        
        // --- CHOFER LOGIC ---
        const loadChoferData = async () => {
            const choferContent = document.getElementById('chofer-content');
            choferContent.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                // Modificado: Trae camiones y cajas desde coordenadas
                const { data: viajes, error } = await supabase.from('viajes').select(`
                    *, 
                    coordenadas(
                        *,
                        camiones(nombre_identificador),
                        cajas(nombre_identificador)
                    )
                `).eq('chofer_id', currentUser.id).order('created_at', {ascending: false});
                if (error) throw error;
                
                const viajesAsignados = viajes.filter(v => v.status === 'Asignado');
                choferContent.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Mis Viajes Asignados</h3>
                    <div class="space-y-4">
                    ${viajesAsignados.length === 0 ? '<p>No tienes viajes asignados.</p>' : viajesAsignados.map(v => `
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg">Viaje #${v.id}</h4>
                                    <p class="text-sm text-gray-500">Asignado: ${new Date(v.created_at).toLocaleDateString()}</p>
                                </div>
                                <span class="text-sm font-medium py-1 px-3 rounded-full bg-blue-100 text-blue-800">${v.status}</span>
                            </div>
                            <div class="mt-4">
                                <h5 class="font-semibold">Ruta:</h5>
                                <ol class="list-decimal list-inside mt-2 text-gray-700 space-y-1">
                                    ${(v.coordenadas && v.coordenadas.length > 0) ? v.coordenadas.sort((a,b)=>a.orden - b.orden).map(c=>`
                                        <li>
                                            ${c.descripcion} - ${c.fecha_entrega}
                                            <br>
                                            <span class="text-xs pl-4 text-gray-600">Camión: ${c.camiones?.nombre_identificador || 'N/A'} | Caja: ${c.cajas?.nombre_identificador || 'N/A'}</span>
                                        </li>
                                    `).join('') : '<li>Sin ruta.</li>'}
                                </ol>
                            </div>
                            <div class="mt-4 text-right"><button data-viaje-id="${v.id}" class="complete-viaje-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Completar Viaje</button></div>
                        </div>`).join('')}
                    </div>`;
            } catch(err) {
                showAlert(`Error al cargar tus viajes: ${err.message}`, 'error');
                choferContent.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };

        const openUploadModal = (viajeId) => {
            const modal = document.getElementById('upload-modal');
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-lg m-auto">
                    <div id="upload-form-container">
                        <h3 class="text-xl font-semibold mb-4">Completar Viaje #${viajeId}</h3>
                        <p class="text-gray-600 mb-6">Sube el comprobante de diésel para marcar este viaje como completado.</p>
                        <form id="complete-trip-form" data-viaje-id="${viajeId}">
                            <div class="mb-4">
                                <label for="pod-file" class="block text-sm font-medium text-gray-700 mb-2">Archivo del Comprobante</label>
                                <input type="file" id="pod-file" name="podFile" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                            <div class="mt-6 flex justify-end gap-4">
                                <button type="button" class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Subir y Completar</button>
                            </div>
                        </form>
                    </div>
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="loader mx-auto"></div>
                        <p class="text-center mt-2">Subiendo archivo, por favor espera...</p>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
        };

        const handleTripCompletion = async (event) => {
            event.preventDefault();
            const form = event.target;
            const viajeId = form.dataset.viajeId;
            const fileInput = document.getElementById('pod-file');
            const file = fileInput.files[0];

            if (!file) { showAlert('Por favor, selecciona un archivo.', 'error'); return; }

            document.getElementById('upload-form-container').classList.add('hidden');
            document.getElementById('upload-progress').classList.remove('hidden');

            try {
                const filePath = `public/${currentUser.id}/${viajeId}-${Date.now()}-${file.name}`;
                const { error: uploadError } = await supabase.storage.from('recibos').upload(filePath, file);
                if (uploadError) throw uploadError;

                const { data: urlData } = supabase.storage.from('recibos').getPublicUrl(filePath);
                const { error: updateError } = await supabase.from('viajes').update({ status: 'Completado', recibo_diesel_url: urlData.publicUrl }).eq('id', viajeId);
                if (updateError) throw updateError;
                
                showAlert('¡Viaje completado con éxito!');
                document.getElementById('upload-modal').classList.add('hidden');
                await loadChoferData();
            } catch (err) {
                showAlert(`Error al completar el viaje: ${err.message}`, 'error');
                document.getElementById('upload-form-container').classList.remove('hidden');
                document.getElementById('upload-progress').classList.add('hidden');
            }
        };
        
        // --- TRAFICO LOGIC ---
        const addCoordenadaInput = (containerId, data = { desc: '', date: '', camion_id: null, caja_id: null }) => {
            const container = document.getElementById(containerId);
            if(!container) return;
            const count = container.children.length;
            
            // --- CAMBIO ---
            // Ya no leemos los valores default del formulario principal, ya que se eliminaron.
            // const formId = containerId.includes('create') ? 'create-viaje-form' : 'edit-viaje-form';
            // const formElement = document.getElementById(formId);
            
            let defaultCamionId = data.camion_id;
            let defaultCajaId = data.caja_id;

            // if (formElement) {
            //     if (!defaultCamionId) defaultCamionId = formElement.querySelector('select[name="camion"]')?.value;
            //     if (!defaultCajaId) defaultCajaId = formElement.querySelector('select[name="caja"]')?.value;
            // }
            // --- FIN CAMBIO ---
            
            const camionesOptions = adminDropdownCache.camiones.map(c => `<option value="${c.id}" ${c.id == defaultCamionId ? 'selected' : ''}>${c.nombre_identificador}</option>`).join('');
            const cajasOptions = adminDropdownCache.cajas.map(c => `<option value="${c.id}" ${c.id == defaultCajaId ? 'selected' : ''}>${c.nombre_identificador}</option>`).join('');

            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-12 gap-2 items-center border p-3 rounded-md bg-white';
            div.innerHTML = `
                <div class="col-span-12 md:col-span-4"><input type="text" name="coordenada_desc" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Descripción ${count + 1}" value="${data.desc}"></div>
                <div class="col-span-12 md:col-span-3"><input type="date" name="coordenada_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${data.date}"></div>
                <div class="col-span-12 md:col-span-2"><select name="coordenada_camion" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">${camionesOptions}</select></div>
                <div class="col-span-12 md:col-span-2"><select name="coordenada_caja" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">${cajasOptions}</select></div>
                <button type="button" class="remove-coordenada-btn text-red-500 hover:text-red-700 font-bold md:col-span-1 text-lg text-center">X</button>
            `;
            container.appendChild(div);
        };

        const loadTraficoData = async () => {
            const traficoContent = document.getElementById('trafico-content');
            traficoContent.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                // Cargar camiones y cajas primero
                await loadAdminDropdowns();
                
                const { data: choferes } = await supabase.from('profiles').select('id, full_name').eq('role', 'Chofer');
                const camionesOptions = adminDropdownCache.camiones.map(c => `<option value="${c.id}">${c.nombre_identificador}</option>`).join('');
                const cajasOptions = adminDropdownCache.cajas.map(c => `<option value="${c.id}">${c.nombre_identificador}</option>`).join('');

                traficoContent.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-lg border">
                        <h3 class="text-xl font-semibold mb-4">Crear Nuevo Viaje</h3>
                        <form id="create-viaje-form" class="space-y-4">
                            <!-- CAMBIO: Quitado grid de 3, ahora solo 1 campo -->
                            <div>
                                <label class="block text-sm font-medium">Chofer</label>
                                <select name="chofer" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${choferes.map(c=>`<option value="${c.id}">${c.full_name}</option>`).join('')}</select>
                            </div>
                            <!-- FIN CAMBIO -->
                            <div>
                                <h4 class="text-lg font-medium">Ruta</h4>
                                <div id="coordenadas-container-create" class="mt-2 space-y-3 bg-gray-100 p-2 rounded-md"></div>
                                <button type="button" class="add-coordenada-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 font-semibold py-1 px-3 rounded-lg" data-container="coordenadas-container-create">+ Agregar Coordenada</button>
                            </div>
                            <div class="pt-4"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700">Asignar Viaje</button></div>
                        </form>
                    </div>
                    <div class="mt-8"><h3 class="text-xl font-semibold mb-4">Viajes Asignados</h3><div id="assigned-viajes-list" class="space-y-4"></div></div>`;
                addCoordenadaInput('coordenadas-container-create');
                await loadAssignedViajes();
            } catch (err) {
                 showAlert(`Error al cargar datos de Tráfico: ${err.message}`, 'error');
                 traficoContent.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };
        const loadAssignedViajes = async () => {
            const listContainer = document.getElementById('assigned-viajes-list');
            listContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            // Quitada la lógica de camiones/cajas de aquí, se maneja en coordenadas
            const { data: viajes, error } = await supabase.from('viajes').select(`id, chofer:chofer_id(full_name)`).eq('status', 'Asignado').order('created_at', { ascending: false });
            if(error) { showAlert(`Error: ${error.message}`, 'error'); listContainer.innerHTML = ''; return; }
            if(viajes.length === 0) { listContainer.innerHTML = `<p class="text-gray-500">No hay viajes asignados actualmente.</p>`; return; }
            listContainer.innerHTML = viajes.map(v => `
                <div class="bg-white p-4 rounded-lg border flex justify-between items-center gap-4 flex-wrap">
                    <div>
                        <p class="font-bold">Viaje #${v.id}</p>
                        <p class="text-sm text-gray-600">Chofer: ${v.chofer.full_name}</p>
                    </div>
                    <div><button class="edit-viaje-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg" data-viaje-id="${v.id}">Editar</button></div>
                </div>`).join('');
        };
        
        const openEditViajeModal = async (viajeId) => {
            const modal = document.getElementById('edit-viaje-modal');
            modal.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-md w-full max-w-3xl m-auto"><div class="loader mx-auto"></div></div>`;
            modal.classList.remove('hidden');

            try {
                await loadAdminDropdowns(); // Asegurar que tenemos camiones/cajas
                
                const { data: viaje, error: viajeError } = await supabase.from('viajes').select('*, coordenadas(*)').eq('id', viajeId).single();
                if (viajeError) throw viajeError;
                
                const { data: choferes } = await supabase.from('profiles').select('id, full_name').eq('role', 'Chofer');
                const camionesOptions = adminDropdownCache.camiones.map(c => `<option value="${c.id}">${c.nombre_identificador}</option>`).join('');
                const cajasOptions = adminDropdownCache.cajas.map(c => `<option value="${c.id}">${c.nombre_identificador}</option>`).join('');
                
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-3xl m-auto max-h-[90vh] flex flex-col">
                         <h3 class="text-xl font-semibold mb-6 flex-shrink-0">Editar Viaje #${viajeId}</h3>
                         <form id="edit-viaje-form" data-viaje-id="${viajeId}" class="space-y-4 flex-grow overflow-y-auto pr-2">
                            <!-- CAMBIO: Quitado grid de 3, ahora solo 1 campo -->
                            <div>
                                <label class="block text-sm font-medium">Chofer</label>
                                <select name="chofer" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">${choferes.map(c=>`<option value="${c.id}" ${c.id === viaje.chofer_id ? 'selected':''}>${c.full_name}</option>`).join('')}</select>
                            </div>
                            <!-- FIN CAMBIO -->
                            <div>
                                <h4 class="text-lg font-medium">Ruta</h4>
                                <div id="coordenadas-container-edit" class="mt-2 space-y-3 bg-gray-100 p-2 rounded-md"></div>
                                <button type="button" class="add-coordenada-btn mt-2 text-sm bg-gray-200 hover:bg-gray-300 font-semibold py-1 px-3 rounded-lg" data-container="coordenadas-container-edit">+ Agregar Coordenada</button>
                            </div>
                         </form>
                         <div class="flex justify-end gap-4 mt-6 pt-4 border-t flex-shrink-0">
                            <button type="button" class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" form="edit-viaje-form" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                         </div>
                    </div>`;

                // Cargar coordenadas existentes
                viaje.coordenadas.sort((a,b)=>a.orden - b.orden).forEach(coord => {
                    addCoordenadaInput('coordenadas-container-edit', { 
                        desc: coord.descripcion, 
                        date: coord.fecha_entrega,
                        camion_id: coord.camion_id,
                        caja_id: coord.caja_id
                    });
                });
                if(viaje.coordenadas.length === 0) addCoordenadaInput('coordenadas-container-edit');

            } catch (err) {
                 showAlert(`Error al cargar datos del viaje: ${err.message}`, 'error');
                 modal.classList.add('hidden');
            }
        };
        
        const handleViajeSubmit = async (event, isEdit = false) => {
            const form = event.target;
            const viajeId = form.dataset.viajeId;
            const formData = new FormData(form);
            const choferId = formData.get('chofer');
            
            let currentViajeId = viajeId;

            if (isEdit) {
                // Actualizar el chofer del viaje principal
                const { error: updateError } = await supabase.from('viajes').update({
                    chofer_id: choferId
                }).eq('id', viajeId);
                if (updateError) throw updateError;
                
                // Borrar coordenadas antiguas
                const { error: deleteError } = await supabase.from('coordenadas').delete().eq('viaje_id', viajeId);
                if(deleteError) throw deleteError;

            } else {
                // Crear nuevo viaje solo con chofer_id y status
                const { data: viajeData, error: viajeError } = await supabase.from('viajes').insert({
                    chofer_id: choferId, status: 'Asignado'
                }).select().single();
                if (viajeError) throw viajeError;
                currentViajeId = viajeData.id;
            }

            // Recoger y crear nuevas coordenadas
            const descInputs = Array.from(form.querySelectorAll('input[name="coordenada_desc"]'));
            const dateInputs = Array.from(form.querySelectorAll('input[name="coordenada_date"]'));
            const camionInputs = Array.from(form.querySelectorAll('select[name="coordenada_camion"]'));
            const cajaInputs = Array.from(form.querySelectorAll('select[name="coordenada_caja"]'));

            const coordenadas = descInputs.map((descInput, index) => ({
                viaje_id: currentViajeId,
                descripcion: descInput.value,
                fecha_entrega: dateInputs[index].value,
                camion_id: camionInputs[index].value,
                caja_id: cajaInputs[index].value,
                orden: index + 1
            })).filter(c => c.descripcion && c.fecha_entrega && c.camion_id && c.caja_id);

            if (coordenadas.length > 0) {
                const { error: coordError } = await supabase.from('coordenadas').insert(coordenadas);
                if (coordError) throw coordError;
            }
            
            if (isEdit) {
                showAlert('¡Viaje actualizado con éxito!');
                document.getElementById('edit-viaje-modal').classList.add('hidden');
            } else {
                showAlert('¡Viaje creado y asignado con éxito!');
                form.reset();
                document.getElementById('coordenadas-container-create').innerHTML = '';
                addCoordenadaInput('coordenadas-container-create');
            }
            
            await loadAssignedViajes();
        };

        // --- ADMIN LOGIC ---
        
        // --- Estado de Paginación de Cajas ---
        let adminCajasCurrentPage = 1;
        // const CAJAS_PER_PAGE = 300; // Eliminado: Ahora es dinámico
        let adminCajasCache = {}; // Cache para los dropdowns
        
        const openConfirmModal = (message, onConfirm) => {
            const modal = document.getElementById('confirm-modal');
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm m-auto">
                    <p class="text-center mb-4">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancelar</button>
                        <button id="confirm-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Confirmar</button>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
            document.getElementById('confirm-cancel').onclick = closeConfirmModal;
            document.getElementById('confirm-ok').onclick = onConfirm;
        };
        const closeConfirmModal = () => { document.getElementById('confirm-modal').classList.add('hidden'); };

        const openRouteModal = (coordenadas) => {
             const modal = document.getElementById('view-route-modal');
             modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md m-auto">
                    <h4 class="font-semibold text-lg mb-4">Ruta del Viaje</h4>
                    ${coordenadas && coordenadas.length > 0 ? `
                    <ol class="list-decimal list-inside space-y-2">
                        ${coordenadas.sort((a,b)=>a.orden-b.orden).map(c => `
                            <li>
                                <span class="font-medium">${c.descripcion}</span> - ${c.fecha_entrega}
                                <br>
                                <span class="text-xs pl-4 text-gray-600">Camión: ${c.camiones?.nombre_identificador || 'N/A'} | Caja: ${c.cajas?.nombre_identificador || 'N/A'}</span>
                            </li>
                        `).join('')}
                    </ol>
                    ` : '<p>Este viaje no tiene una ruta definida.</p>'}
                    <div class="text-right mt-6">
                        <button class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
        };

        const loadAdminData = async () => {
            const selectedTab = document.querySelector('.tab-btn.text-blue-600').dataset.tab;
            switch(selectedTab) {
                case 'viajes': await loadAdminViajesData(); break;
                case 'camiones': await loadAdminCamionesData(); break;
                case 'cajas': await loadAdminCajasData(false); break; // Carga inicial
                case 'usuarios': await loadAdminUsersData(); break;
                case 'reportes': await loadAdminReportsData(); break;
            }
        };
        
        const loadAdminViajesData = async () => {
            const container = document.getElementById('admin-content-viajes');
            container.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: viajes, error } = await supabase.from('viajes').select(`
                    *, 
                    chofer:chofer_id(full_name), 
                    coordenadas(
                        *,
                        camiones(nombre_identificador),
                        cajas(nombre_identificador)
                    )
                `).order('created_at', { ascending: false });
                if (error) throw error;
                
                const statusColors = {
                    Asignado: 'bg-blue-100 text-blue-800',
                    Completado: 'bg-yellow-100 text-yellow-800',
                    Pagado: 'bg-green-100 text-green-800'
                };

                container.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Monitor de Todos los Viajes</h3>
                    ${viajes.length === 0 ? '<p>No hay viajes registrados.</p>' : `
                        <div class="overflow-x-auto"><table class="min-w-full bg-white text-sm">
                            <thead class="bg-gray-100"><tr>
                                <th class="py-2 px-4 text-left">ID</th>
                                <th class="py-2 px-4 text-left">Fecha</th>
                                <th class="py-2 px-4 text-left">Chofer</th>
                                <th class="py-2 px-4 text-left">Unidades (1ra Parada)</th>
                                <th class="py-2 px-4 text-center">Estado</th>
                                <th class="py-2 px-4 text-center">Recibo</th>
                                <th class="py-2 px-4 text-center">Ruta</th>
                            </tr></thead>
                            <tbody>${viajes.map(v => {
                                const primeraParada = v.coordenadas?.sort((a,b)=>a.orden-b.orden)[0];
                                return `<tr class="border-b">
                                    <td class="py-2 px-4 font-mono text-xs">${v.id}</td>
                                    <td class="py-2 px-4">${new Date(v.created_at).toLocaleDateString()}</td>
                                    <td class="py-2 px-4">${v.chofer?.full_name || 'N/A'}</td>
                                    <td class="py-2 px-4">${primeraParada ? `${primeraParada.camiones?.nombre_identificador || 'N/A'} / ${primeraParada.cajas?.nombre_identificador || 'N/A'}` : 'N/A'}</td>
                                    <td class="py-2 px-4 text-center"><span class="py-1 px-3 rounded-full font-medium text-xs ${statusColors[v.status] || ''}">${v.status}</span></td>
                                    <td class="py-2 px-4 text-center">${v.recibo_diesel_url ? `<a href="${v.recibo_diesel_url}" target="_blank" class="text-blue-500 hover:underline">Ver</a>` : 'Pendiente'}</td>
                                    <td class="py-2 px-4 text-center"><button class="view-route-btn text-blue-500 hover:underline" data-viaje-id="${v.id}">Ver</button></td>
                                </tr>`
                            }).join('')}</tbody>
                        </table></div>`}`;
                
                document.querySelectorAll('.view-route-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const viaje = viajes.find(v => v.id == btn.dataset.viajeId);
                        openRouteModal(viaje.coordenadas);
                    });
                });
            } catch (err) {
                showAlert(`Error al cargar los viajes: ${err.message}`, 'error');
                container.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };

        // --- INICIO: LÓGICA DE GESTIÓN DE CAMIONES ---
        const loadAdminCamionesData = async () => { 
            const container = document.getElementById('admin-content-camiones');
            container.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: camiones } = await supabase.from('camiones').select('*');
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Agregar Nuevo Camión</h3>
                             <form id="admin-add-camion-form" class="bg-gray-50 p-4 rounded-lg space-y-4">
                                <div>
                                    <label class="block text-sm">Nombre Identificador</label>
                                    <input type="text" name="nombre" placeholder="Ej. C-01" required class="w-full mt-1 p-2 border rounded-md">
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Agregar Camión</button>
                             </form>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Camiones Existentes</h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto pr-2">${camiones.map(c => `
                                <div class="bg-gray-50 p-2 rounded-lg flex justify-between items-center">
                                    <span>${c.nombre_identificador}</span>
                                    <button class="delete-fleet-btn text-red-500 hover:text-red-700" data-id="${c.id}" data-type="camiones">Eliminar</button>
                                </div>`).join('')}
                            </div>
                        </div>
                    </div>`;
            } catch(err) {
                showAlert(`Error al cargar la flota: ${err.message}`, 'error');
                container.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };
        
        const handleCamionAdd = async (event) => {
             const form = event.target;
             const nombre = form.nombre.value;
             const { error } = await supabase.from('camiones').insert({ nombre_identificador: nombre });
             if (error) { showAlert(`Error: ${error.message}`, 'error'); }
             else { showAlert('¡Camión agregado con éxito!'); form.reset(); await loadAdminCamionesData(); await loadAdminDropdowns(true); } // Recargar dropdowns
        };
        // --- FIN: LÓGICA DE GESTIÓN DE CAMIONES ---


        // --- INICIO: LÓGICA DE GESTIÓN DE CAJAS (PAGINADA) ---

        // Dibuja la estructura HTML de la sección de cajas (filtros, lista, paginación)
        const drawCajasLayout = async (container) => {
            // Carga los valores para los dropdowns (si no están en caché)
            // Eliminada la carga de 'propiedad' y 'propietario'
            if (!adminCajasCache.propiedad || !adminCajasCache.propietario) {
                // const { data: propiedades } = await supabase.from('distinct_caja_propiedad').select('propiedad'); // Eliminado
                // const { data: propietarios } = await supabase.from('distinct_caja_propietario').select('propietario'); // Eliminado
                
                // --- FIX: Añadir (|| []) para evitar el error .map() en null ---
                // adminCajasCache.propiedad = [...new Set((propiedades || []).map(item => item.propiedad).filter(Boolean))].sort(); // Eliminado
                // adminCajasCache.propietario = [...new Set((propietarios || []).map(item => item.propietario).filter(Boolean))].sort(); // Eliminado
                
                // Marcamos como cargado para no re-intentar
                adminCajasCache.propiedad = [];
                adminCajasCache.propietario = [];
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Columna de Formulario -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Agregar Nueva Caja</h3>
                         <form id="admin-add-caja-form" class="bg-gray-50 p-4 rounded-lg space-y-3">
                            <div>
                                <label class="block text-sm">Nombre/Número</label>
                                <input type="text" name="nombre_identificador" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Placa</label>
                                <input type="text" name="placa" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Tipo</label>
                                <input type="text" name="tipo" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Medida</label>
                                <input type="text" name="medida" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Núm. Llantas</label>
                                <input type="text" name="num_llantas" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Origen</label>
                                <input type="text" name="origen" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Propiedad</label>
                                <input type="text" name="propiedad" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Propietario</label>
                                <input type="text" name="propietario" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Estatus</label>
                                <input type="text" name="estatus" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Agregar Caja</button>
                         </form>
                    </div>

                    <!-- Columna de Lista -->
                    <div class="md:col-span-2">
                        <h4 class="font-semibold text-lg mb-2">Lista de Cajas Existentes</h4>
                        <!-- Filtros -->
                        <div class="bg-gray-50 p-3 rounded-lg mb-4 grid grid-cols-1 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Buscar por Nombre/Placa</label>
                                <input type="text" id="caja-filter-search" class="w-full mt-1 p-2 border rounded-md text-sm" placeholder="Buscar...">
                            </div>
                            <!-- Filtros de Propiedad y Propietario eliminados -->
                        </div>
                        
                        <!-- Leyenda de conteo -->
                        <div id="cajas-count-legend" class="text-sm text-gray-600 mb-2">Cargando...</div>
                        
                        <!-- Contenedor de la lista -->
                        <div id="cajas-list-container" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2 border rounded-lg p-2 bg-white">
                            <div class="loader mx-auto"></div>
                        </div>

                        <!-- Paginación -->
                        <div class="flex flex-wrap justify-between items-center mt-4 gap-4">
                            <button id="cajas-prev-page" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">&lt; Anterior</button>
                            
                            <div class="flex items-center gap-4">
                                <!-- Nuevo: Selector de registros por página -->
                                <div class="flex items-center gap-2">
                                    <label for="cajas-per-page" class="text-sm font-medium">Registros:</label>
                                    <select id="cajas-per-page" class="border rounded-md p-1.5 text-sm font-medium">
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="300">300</option>
                                        <option value="500" selected>500</option>
                                        <option value="1000">1000</option>
                                    </select>
                                </div>
                                <span class="text-sm font-medium">Página <span id="cajas-current-page">1</span> de <span id="cajas-total-pages">1</span></span>
                            </div>
                            
                            <button id="cajas-next-page" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Siguiente &gt;</button>
                        </div>
                    </div>
                </div>
            `;

            // Añadir listeners a los nuevos elementos
            document.getElementById('caja-filter-search').addEventListener('input', () => { adminCajasCurrentPage = 1; loadAdminCajasData(true); });
            // Listeners de dropdowns eliminados
            // document.getElementById('caja-filter-propiedad').addEventListener('change', () => { adminCajasCurrentPage = 1; loadAdminCajasData(true); });
            // document.getElementById('caja-filter-propietario').addEventListener('change', () => { adminCajasCurrentPage = 1; loadAdminCajasData(true); });
            
            // Nuevo listener para el selector de "por página"
            document.getElementById('cajas-per-page').addEventListener('change', () => { adminCajasCurrentPage = 1; loadAdminCajasData(true); });

            document.getElementById('cajas-prev-page').addEventListener('click', () => { if (adminCajasCurrentPage > 1) { adminCajasCurrentPage--; loadAdminCajasData(true); } });
            document.getElementById('cajas-next-page').addEventListener('click', () => { adminCajasCurrentPage++; loadAdminCajasData(true); });
            
            // Filtro default eliminado
            // document.getElementById('caja-filter-propiedad').value = 'Propio';
        };

        // Carga y recarga los DATOS de las cajas (la lista)
        // isFilterChange = true si es por un filtro, false si es la carga inicial de la pestaña
        const loadAdminCajasData = async (isFilterChange = false) => {
            const container = document.getElementById('admin-content-cajas');
            
            // 1. Dibuja el layout si es la primera vez (carga de pestaña)
            if (!isFilterChange) {
                adminCajasCurrentPage = 1; // Resetea página
                container.innerHTML = `<div class="loader mx-auto"></div>`; // Loader principal
                await drawCajasLayout(container);
            }
            
            // 2. Mostrar loader en la lista mientras se cargan los datos
            const listContainer = document.getElementById('cajas-list-container');
            const legendContainer = document.getElementById('cajas-count-legend');
            listContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            legendContainer.textContent = 'Cargando...';

            try {
                // 1. Recoger filtros
                const searchFilter = document.getElementById('caja-filter-search').value.toLowerCase();
                // Filtros de propiedad y propietario eliminados
                // const propiedadFilter = document.getElementById('caja-filter-propiedad').value;
                // const propietarioFilter = document.getElementById('caja-filter-propietario').value;
                
                // Nuevo: Leer el valor de "por página"
                const perPage = parseInt(document.getElementById('cajas-per-page').value, 10) || 500;

                // 2. Construir la consulta
                let query = supabase.from('cajas').select('*', { count: 'exact' });

                // Aplicar filtros de búsqueda
                if (searchFilter) {
                    query = query.or(`nombre_identificador.ilike.%${searchFilter}%,placa.ilike.%${searchFilter}%`);
                }
                // Filtros exactos eliminados
                // if (propiedadFilter) {
                //     query = query.eq('propiedad', propiedadFilter);
                // }
                // if (propietarioFilter) {
                //     query = query.eq('propietario', propietarioFilter);
                // }

                // 3. Paginación
                const rangeStart = (adminCajasCurrentPage - 1) * perPage;
                const rangeEnd = rangeStart + perPage - 1;
                query = query.range(rangeStart, rangeEnd).order('nombre_identificador', { ascending: true });

                // 4. Ejecutar consulta
                const { data: cajas, error, count } = await query;
                if (error) throw error;

                // 5. Dibujar la lista de cajas
                if (cajas.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center p-4">No se encontraron cajas con esos filtros.</p>';
                } else {
                    listContainer.innerHTML = cajas.map(c => `
                        <div class="caja-card bg-gray-50 p-3 rounded-lg border" 
                             data-id="${c.id}">
                            <div class="flex justify-between items-start">
                                <div class="w-3/4">
                                    <p class="font-bold text-base text-blue-800">${c.nombre_identificador}</p>
                                    <p class="text-sm font-medium text-gray-700">Placa: ${c.placa || 'N/A'}</p>
                                    <p class="text-xs text-gray-600">${c.tipo || 'N/A'} | Medida: ${c.medida || 'N/A'} | ${c.estatus || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${c.propiedad || 'N/A'} - ${c.propietario || 'N/A'}</p>
                                </div>
                                <div class="flex flex-col gap-2 items-end">
                                    <button class="edit-caja-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-1 px-3 rounded-full" data-id="${c.id}">Editar</button>
                                    <button class="delete-fleet-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-full" data-id="${c.id}" data-type="cajas">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // 6. Actualizar UI de paginación
                const totalPages = Math.ceil(count / perPage);
                document.getElementById('cajas-current-page').textContent = adminCajasCurrentPage;
                document.getElementById('cajas-total-pages').textContent = totalPages > 0 ? totalPages : 1;
                document.getElementById('cajas-prev-page').disabled = (adminCajasCurrentPage <= 1);
                document.getElementById('cajas-next-page').disabled = (adminCajasCurrentPage >= totalPages);

                // 7. Actualizar leyenda
                const startRecord = Math.min((adminCajasCurrentPage - 1) * perPage + 1, count);
                const endRecord = Math.min(adminCajasCurrentPage * perPage, count);
                legendContainer.textContent = (count > 0) ? `Mostrando ${startRecord} - ${endRecord} de ${count} cajas` : 'Mostrando 0 cajas';
                
            } catch (err) {
                showAlert(`Error al cargar las cajas: ${err.message}`, 'error');
                listContainer.innerHTML = `<p class="text-red-500 text-center p-4">No se pudieron cargar los datos.</p>`;
                legendContainer.textContent = 'Error al cargar';
            }
        };

        const handleCajaAdd = async (event) => {
             const form = event.target;
             const formData = new FormData(form);
             const newCaja = {
                nombre_identificador: formData.get('nombre_identificador'),
                placa: formData.get('placa'),
                tipo: formData.get('tipo'),
                medida: formData.get('medida'),
                num_llantas: formData.get('num_llantas'),
                origen: formData.get('origen'),
                propiedad: formData.get('propiedad'),
                propietario: formData.get('propietario'),
                estatus: formData.get('estatus'),
             };
             
             const { error } = await supabase.from('cajas').insert(newCaja);
             if (error) { showAlert(`Error: ${error.message}`, 'error'); }
             else { showAlert('¡Caja agregada con éxito!'); form.reset(); await loadAdminCajasData(true); await loadAdminDropdowns(true); } // Recargar datos
        };
        
        const openEditCajaModal = async (cajaId) => {
            const modal = document.getElementById('edit-caja-modal');
            modal.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-md w-full max-w-lg m-auto"><div class="loader mx-auto"></div></div>`;
            modal.classList.remove('hidden');

            try {
                const { data: caja, error } = await supabase.from('cajas').select('*').eq('id', cajaId).single();
                if (error) throw error;
                
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-lg m-auto max-h-[90vh] flex flex-col">
                         <h3 class="text-xl font-semibold mb-6 flex-shrink-0">Editar Caja #${caja.nombre_identificador}</h3>
                         <form id="edit-caja-form" data-caja-id="${caja.id}" class="space-y-3 flex-grow overflow-y-auto pr-2">
                            <div>
                                <label class="block text-sm">Nombre/Número</label>
                                <input type="text" name="nombre_identificador" value="${c.nombre_identificador || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Placa</label>
                                <input type="text" name="placa" value="${c.placa || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Tipo</label>
                                <input type="text" name="tipo" value="${c.tipo || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Medida</label>
                                <input type="text" name="medida" value="${c.medida || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Núm. Llantas</label>
                                <input type="text" name="num_llantas" value="${c.num_llantas || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Origen</label>
                                <input type="text" name="origen" value="${c.origen || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Propiedad</label>
                                <input type="text" name="propiedad" value="${c.propiedad || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Propietario</label>
                                <input type="text" name="propietario" value="${c.propietario || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                            <div>
                                <label class="block text-sm">Estatus</label>
                                <input type="text" name="estatus" value="${c.estatus || ''}" required class="w-full mt-1 p-2 border rounded-md text-sm">
                            </div>
                         </form>
                         <div class="flex justify-end gap-4 mt-6 pt-4 border-t flex-shrink-0">
                            <button type="button" class="close-modal-btn bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" form="edit-caja-form" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                         </div>
                    </div>`;

            } catch (err) {
                 showAlert(`Error al cargar datos de la caja: ${err.message}`, 'error');
                 modal.classList.add('hidden');
            }
        };

        const handleUpdateCaja = async (event) => {
            const form = event.target;
            const cajaId = form.dataset.cajaId;
            const formData = new FormData(form);
             const updatedCaja = {
                nombre_identificador: formData.get('nombre_identificador'),
                placa: formData.get('placa'),
                tipo: formData.get('tipo'),
                medida: formData.get('medida'),
                num_llantas: formData.get('num_llantas'),
                origen: formData.get('origen'),
                propiedad: formData.get('propiedad'),
                propietario: formData.get('propietario'),
                estatus: formData.get('estatus'),
             };
            
            const { error } = await supabase.from('cajas').update(updatedCaja).eq('id', cajaId);
            if (error) { showAlert(`Error: ${error.message}`, 'error'); }
            else { 
                showAlert('¡Caja actualizada con éxito!'); 
                document.getElementById('edit-caja-modal').classList.add('hidden');
                await loadAdminCajasData(true); // Recargar datos
                await loadAdminDropdowns(true); // Recargar dropdowns por si cambió el nombre
            }
        };

        const handleFleetDelete = async (id, type) => {
            // Lógica de validación mejorada para 'cajas'
            if (type === 'cajas') {
                try {
                    // 1. Verificar si la caja está en un viaje 'Asignado'
                    const { data: viajes, error: searchError } = await supabase
                        .from('coordenadas')
                        .select('viaje_id, viajes(status)')
                        .eq('caja_id', id);
                    
                    if (searchError) throw searchError;

                    // 2. Filtrar solo los viajes que están 'Asignados'
                    const viajesActivos = viajes.filter(v => v.viajes.status === 'Asignado');

                    if (viajesActivos.length > 0) {
                        showAlert('No se puede eliminar: La caja está asignada a un viaje activo.', 'error');
                        return;
                    }

                    // 3. Si no hay viajes activos, proceder con la confirmación de borrado
                    openConfirmModal(`¿Seguro que quieres eliminar esta caja?`, async () => {
                        const { error } = await supabase.from('cajas').delete().eq('id', id);
                        if (error) { showAlert(`Error: ${error.message}`, 'error'); } 
                        else { showAlert('Caja eliminada.'); await loadAdminCajasData(true); await loadAdminDropdowns(true); } // Recargar datos
                        closeConfirmModal();
                    });

                } catch (err) {
                    showAlert(`Error al verificar la caja: ${err.message}`, 'error');
                }
            
            } else if (type === 'camiones') {
                // Lógica simple de confirmación para 'camiones'
                openConfirmModal(`¿Seguro que quieres eliminar este camión?`, async () => {
                    const { error } = await supabase.from(type).delete().eq('id', id);
                    if (error) { showAlert(`Error: ${error.message}`, 'error'); } 
                    else { showAlert('Camión eliminado.'); await loadAdminCamionesData(); await loadAdminDropdowns(true); }
                    closeConfirmModal();
                });
            }
        };
        // --- FIN: LÓGICA DE GESTIÓN DE CAJAS ---


        const loadAdminUsersData = async () => { 
             const usersContainer = document.getElementById('admin-content-usuarios');
            usersContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const { data: profiles } = await supabase.from('profiles').select('*');
                usersContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Usuarios Activos</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto pr-2">${profiles.map(u => `
                            <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-semibold">${u.full_name || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">${u.role || 'N/A'} ${u.role === 'Chofer' ? `| ${u.tipo_operador || 'N/A'}`: ''}</p>
                                </div>
                                <button class="delete-user-btn text-red-500 hover:text-red-700" data-user-id="${u.id}">Eliminar</button>
                            </div>`).join('')}
                        </div>
                    </div>
                    <div>
                         <h3 class="text-xl font-semibold mb-4">Crear Nuevo Usuario</h3>
                         <form id="create-user-form" class="bg-gray-50 p-4 rounded-lg space-y-4">
                            <div><label class="block text-sm">Nombre Completo</label><input type="text" name="fullname" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="block text-sm">Correo Electrónico</label><input type="email" name="email" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div><label class="block text-sm">Contraseña</label><input type="password" name="password" required class="w-full mt-1 p-2 border rounded-md"></div>
                            <div>
                                <label class="block text-sm">Rol</label>
                                <select name="role" required class="w-full mt-1 p-2 border rounded-md">
                                    <option value="Chofer">Chofer</option><option value="Trafico">Tráfico</option><option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div id="tipo-operador-container">
                                <label class="block text-sm">Tipo de Operador (Si es Chofer)</label>
                                <select name="tipo_operador" class="w-full mt-1 p-2 border rounded-md">
                                    <option value="Local">Local</option><option value="Cruce">Cruce</option><option value="Foráneo Chihuahua">Foráneo Chihuahua</option><option value="Foráneo Pacífico">Foráneo Pacífico</tr >
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Crear Usuario</button>
                         </form>
                    </div>
                </div>`;

                const roleSelect = usersContainer.querySelector('select[name="role"]');
                const tipoOperadorContainer = usersContainer.querySelector('#tipo-operador-container');
                roleSelect.addEventListener('change', () => {
                    tipoOperadorContainer.style.display = roleSelect.value === 'Chofer' ? 'block' : 'none';
                });
                tipoOperadorContainer.style.display = roleSelect.value === 'Chofer' ? 'block' : 'none';

            } catch (err) {
                 showAlert(`Error al cargar usuarios: ${err.message}`, 'error');
                 usersContainer.innerHTML = `<p class="text-red-500">No se pudieron cargar los datos.</p>`;
            }
        };
        const loadAdminReportsData = async () => {
            const container = document.getElementById('admin-content-reportes');
            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Generar Reportes en Excel</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-semibold text-lg mb-2">Reporte de Viajes Asignados</h4>
                        <p class="text-gray-600 mb-4 text-sm">Descarga una lista de todos los viajes que están actualmente en curso y pendientes de completar por los choferes.</p>
                        <button data-status="Asignado" class="download-report-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Descargar Asignados</button>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-semibold text-lg mb-2">Reporte de Viajes Completados</h4>
                        <p class="text-gray-600 mb-4 text-sm">Descarga un historial de todos los viajes que han sido completados, incluyendo los que ya han sido pagados.</p>
                        <button data-status="Completado" class="download-report-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Descargar Completados y Pagados</button>
                    </div>
                    <!-- Nuevo Reporte de Cajas -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-semibold text-lg mb-2">Reporte General de Cajas</h4>
                        <p class="text-gray-600 mb-4 text-sm">Descarga la lista completa de todas las cajas registradas en el sistema (puede tardar unos segundos).</p>
                        <button data-type="cajas" class="download-report-btn w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">Descargar Reporte de Cajas</button>
                    </div>
                </div>
            `;
        };
        const handleDownloadReport = async (button) => {
            const status = button.dataset.status;
            const type = button.dataset.type;

            if (type === 'cajas') {
                await handleDownloadCajasReport(button);
                return;
            }

            // Lógica existente para reportes de viajes
            const statuses = status === 'Completado' ? ['Completado', 'Pagado'] : [status];
            button.disabled = true;
            button.textContent = 'Generando...';
            showAlert('Generando reporte, por favor espera...');
            
            try {
                const { data: viajes, error } = await supabase.from('viajes').select(`
                    *, 
                    chofer:chofer_id(full_name), 
                    coordenadas(
                        *,
                        camiones(nombre_identificador),
                        cajas(nombre_identificador)
                    )
                `).in('status', statuses).order('created_at', { ascending: false });
                
                if (error) throw error;
                if (viajes.length === 0) { showAlert('No hay datos para generar este reporte.', 'error'); return; }

                const reportData = [];
                viajes.forEach(v => {
                    const baseData = {
                        'ID Viaje': v.id,
                        'Fecha': new Date(v.created_at).toLocaleDateString(),
                        'Chofer': v.chofer?.full_name,
                        'Estado': v.status,
                        'URL Recibo': v.recibo_diesel_url,
                        'Pago Total': v.pago_total,
                        'Desglose Pago': v.pago_desglose ? JSON.stringify(v.pago_desglose) : ''
                    };

                    if (v.coordenadas && v.coordenadas.length > 0) {
                        v.coordenadas.sort((a, b) => a.orden - b.orden);
                        v.coordenadas.forEach((coord, index) => {
                            baseData[`Parada ${index + 1} - Descripcion`] = coord.descripcion;
                            baseData[`Parada ${index + 1} - Fecha`] = coord.fecha_entrega;
                            baseData[`Parada ${index + 1} - Camion`] = coord.camiones?.nombre_identificador;
                            baseData[`Parada ${index + 1} - Caja`] = coord.cajas?.nombre_identificador;
                        });
                    }
                    
                    reportData.push(baseData);
                });
                
                const worksheet = XLSX.utils.json_to_sheet(reportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Viajes");
                const fileName = `Reporte_Viajes_${statuses.join('_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);

            } catch (err) { showAlert(`Error al generar el reporte: ${err.message}`, 'error'); }
            finally {
                button.disabled = false;
                button.textContent = status === 'Completado' ? 'Descargar Completados y Pagados' : 'Descargar Asignados';
            }
        };

        // Nueva función para el reporte de cajas con paginación
        const handleDownloadCajasReport = async (button) => {
            button.disabled = true;
            button.textContent = 'Generando... (0%)';
            showAlert('Generando reporte de cajas. Esto puede tardar...');

            try {
                const BATCH_SIZE = 1000;
                let allCajas = [];
                let rangeStart = 0;
                let hasMore = true;
                let totalCount = 0;

                // 1. Obtener el conteo total primero
                const { count, error: countError } = await supabase.from('cajas').select('*', { count: 'exact', head: true });
                if (countError) throw countError;
                totalCount = count;
                if (totalCount === 0) {
                    showAlert('No hay cajas para reportar.', 'error');
                    return;
                }

                // 2. Traer los datos en lotes
                while (hasMore) {
                    const rangeEnd = rangeStart + BATCH_SIZE - 1;
                    const { data: cajas, error } = await supabase.from('cajas')
                        .select('*')
                        .range(rangeStart, rangeEnd)
                        .order('nombre_identificador', { ascending: true });
                    
                    if (error) throw error;

                    allCajas.push(...cajas);
                    rangeStart += BATCH_SIZE;
                    hasMore = cajas.length === BATCH_SIZE;

                    const percent = Math.round((allCajas.length / totalCount) * 100);
                    button.textContent = `Generando... (${percent}%)`;
                }

                // 3. Preparar los datos (eliminar campos internos de Supabase si es necesario)
                const reportData = allCajas.map(c => ({
                    'Nombre': c.nombre_identificador,
                    'Placa': c.placa,
                    'Tipo': c.tipo,
                    'Medida': c.medida,
                    'Num Llantas': c.num_llantas,
                    'Origen': c.origen,
                    'Propiedad': c.propiedad,
                    'Propietario': c.propietario,
                    'Estatus': c.estatus,
                    'ID Interno': c.id,
                    'Fecha Creacion': new Date(c.created_at).toLocaleString()
                }));
                
                // 4. Generar Excel
                const worksheet = XLSX.utils.json_to_sheet(reportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Cajas");
                const fileName = `Reporte_General_Cajas_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);

            } catch (err) { 
                showAlert(`Error al generar el reporte de cajas: ${err.message}`, 'error'); 
            } finally {
                button.disabled = false;
                button.textContent = 'Descargar Reporte de Cajas';
            }
        };


        const handleCreateUser = async (event) => {
            const { data: { session: adminSession } } = await supabase.auth.getSession();
            if (!adminSession) { showAlert('Error de autenticación.', 'error'); return; }
            try {
                const formData = new FormData(event.target);
                const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email: formData.get('email'), password: formData.get('password') });
                if (signUpError) throw signUpError;
                const { error: profileError } = await supabase.from('profiles').insert({
                    id: signUpData.user.id, full_name: formData.get('fullname'), role: formData.get('role'),
                    tipo_operador: formData.get('role') === 'Chofer' ? formData.get('tipo_operador') : null
                });
                if (profileError) throw profileError;
                showAlert('¡Usuario creado con éxito!');
                event.target.reset();
                await loadAdminUsersData();
            } catch (err) {
                if (err.message && err.message.includes('User already registered')) {
                     showAlert('Este correo ya está registrado en el sistema. Si el usuario fue eliminado previamente, su registro de autenticación aún existe. Por favor, usa un correo diferente o contacta al administrador de la base de datos.', 'error');
                } else {
                    showAlert(`Error: ${err.message}`, 'error');
                }
            } finally {
                await supabase.auth.setSession({ access_token: adminSession.access_token, refresh_token: adminSession.refresh_token, });
            }
        };
        const handleDeleteUser = async (userId) => {
            if (userId === currentUser.id) { showAlert('No puedes eliminar tu propia cuenta.', 'error'); return; }
            openConfirmModal(`¿Seguro que quieres eliminar este perfil de usuario? La cuenta de autenticación no se eliminará.`, async () => {
                const { error } = await supabase.from('profiles').delete().eq('id', userId);
                if (error) { showAlert(`Error: ${error.message}`, 'error'); }
                else { showAlert('Perfil de usuario eliminado.'); await loadAdminUsersData(); }
                closeConfirmModal();
            });
        };
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        document.addEventListener('click', (event) => {
            // Usar .closest() para delegación de eventos
            const button = event.target.closest('button');
            if(!button) return;

            if(button.id.startsWith('logout-button')) handleLogout();
            
            if(button.classList.contains('tab-btn')) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('text-blue-600', 'border-blue-600');
                    btn.classList.add('text-gray-500', 'border-transparent');
                });
                button.classList.add('text-blue-600', 'border-blue-600');
                document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`admin-content-${button.dataset.tab}`).classList.remove('hidden');
                loadAdminData();
            }
            if(button.classList.contains('add-coordenada-btn')) addCoordenadaInput(button.dataset.container);
            if(button.classList.contains('remove-coordenada-btn')) button.parentElement.remove();
            if(button.classList.contains('edit-viaje-btn')) openEditViajeModal(button.dataset.viajeId);
            if(button.classList.contains('edit-caja-btn')) openEditCajaModal(button.closest('.caja-card').dataset.id);
            if(button.classList.contains('close-modal-btn')) button.closest('.fixed').classList.add('hidden');
            if(button.classList.contains('delete-fleet-btn')) handleFleetDelete(button.dataset.id, button.dataset.type);
            if(button.classList.contains('delete-user-btn')) handleDeleteUser(button.dataset.userId);
            if(button.classList.contains('complete-viaje-btn')) openUploadModal(button.dataset.viajeId);
            if(button.classList.contains('download-report-btn')) {
                handleDownloadReport(button);
            }
        });

        document.addEventListener('submit', async (event) => {
            try {
                event.preventDefault();
                const form = event.target;
                if (form.id === 'create-viaje-form') await handleViajeSubmit(event, false);
                if (form.id === 'edit-viaje-form') await handleViajeSubmit(event, true);
                if (form.id === 'complete-trip-form') await handleTripCompletion(event);
                if (form.id === 'admin-add-camion-form') await handleCamionAdd(event);
                if (form.id === 'admin-add-caja-form') await handleCajaAdd(event);
                if (form.id === 'edit-caja-form') await handleUpdateCaja(event);
                if (form.id === 'create-user-form') await handleCreateUser(event);
            } catch (err) {
                showAlert(`Error: ${err.message}`, 'error');
                console.error("Submit error:", err);
            }
        });

        checkSession();
    </script>
</body>
</html>


